<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…’ç«¥ç”Ÿé•·ç®¡ç†ç³»çµ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#FAE9C2', card: '#FFFFF0', primary: '#FF9800', secondary: '#BECCE4',
                        accent: '#FFB74D', riskRed: '#D32F2F', riskYellow: '#FBC02D', riskGreen: '#388E3C',
                        infoBlue: '#BBDEFB', infoDark: '#1976D2',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #FAE9C2; color: #000; padding-bottom: 200px; }
        .hidden { display: none !important; }
        .risk-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .tab-btn { border-bottom: 3px solid transparent; opacity: 0.6; font-weight: bold; color: #555; }
        .tab-btn.active { border-bottom: 3px solid #FF9800; opacity: 1; color: #000; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #FFB74D; border-radius: 3px; }

        #debugConsole {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 200px;
            background: #1a1a1a; color: #0f0; font-family: monospace; font-size: 12px;
            padding: 10px; overflow-y: scroll; z-index: 9999; border-top: 4px solid #333;
            opacity: 0.95;
            display: block; 
        }
        .log-err { color: #ff5555; font-weight: bold; }
        .log-warn { color: #ffcc00; }
        .log-info { color: #00ff00; }
        .log-check { color: #aaaaff; }
        
        .marked-for-deletion {
            background-color: #fee2e2 !important;
            opacity: 0.6;
            text-decoration: line-through;
            border: 1px dashed #ef4444 !important;
        }
        .marked-for-deletion input { pointer-events: none; background-color: transparent; }
        
        #undoToast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(100%); opacity: 0;
        }
        #undoToast.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="undoToast" class="fixed bottom-40 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-2xl z-[9999] flex items-center gap-4 hidden">
        <span id="undoMessage">å·²åˆªé™¤</span>
        <button onclick="executeUndo()" class="bg-yellow-500 text-black px-3 py-1 rounded font-bold hover:bg-yellow-400 transition"><i class="fa-solid fa-rotate-left"></i> å¾©åŸ</button>
        <button onclick="closeToast()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
    </div>

    <div id="debugConsole">
        <div style="border-bottom:1px solid #444; margin-bottom:5px; padding-bottom:5px; font-weight:bold; color:#fff; display:flex; justify-content:space-between;">
            <span>ğŸ› ï¸ ç³»çµ±è¨ºæ–·æ—¥èªŒ</span>
            <div>
                <button onclick="testAlertSystem()" class="text-yellow-300 hover:text-yellow-100 mr-3 border border-yellow-600 px-2 rounded text-xs">âš¡ æ¸¬è©¦é¡¯ç¤º</button>
                <button onclick="document.getElementById('debugConsole').style.display='none'" class="text-gray-400 hover:text-white">[é—œé–‰]</button>
            </div>
        </div>
        <div id="logContent"></div>
    </div>

    <nav class="bg-secondary text-gray-800 p-4 shadow-md flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center gap-2"><i class="fa-solid fa-sun text-yellow-600 text-xl animate-pulse"></i><h1 class="text-xl font-bold tracking-wide">å…’ç«¥ç”Ÿé•·ç®¡ç†ç³»çµ±</h1></div>
        <div id="navUser" class="hidden flex items-center gap-3">
            <div class="text-right leading-tight"><span id="userRoleDisplay" class="block text-xs bg-primary text-white px-1 rounded inline-block mb-1"></span><span id="userNameDisplay" class="text-sm font-bold"></span></div>
            <button onclick="logout()" class="bg-white text-gray-800 px-3 py-2 rounded hover:bg-gray-100 transition text-sm font-bold border border-gray-400"><i class="fa-solid fa-sign-out-alt"></i> ç™»å‡º</button>
        </div>
    </nav>

    <main class="flex-grow p-4 md:p-6 max-w-7xl mx-auto w-full">
        
        <div id="authSection" class="max-w-md mx-auto bg-card p-0 rounded-xl shadow-xl mt-10 overflow-hidden border border-gray-300">
            <div class="flex bg-white border-b">
                <button onclick="switchAuthTab('login')" id="tab-login" class="tab-btn active flex-1 py-4 text-center transition">ç™»å…¥ç³»çµ±</button>
                <button onclick="switchAuthTab('register')" id="tab-register" class="tab-btn flex-1 py-4 text-center transition">è¨»å†Šå¸³è™Ÿ</button>
            </div>
            <div class="p-8">
                <form id="loginForm" onsubmit="handleAuth(event, 'login')" class="space-y-6">
                    <div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-800">æ­¡è¿å›ä¾†</h2></div>
                    <div><label class="block text-sm font-bold mb-2 text-gray-700">å¸³è™Ÿ</label><input type="text" id="loginId" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                    <div><label class="block text-sm font-bold mb-2 text-gray-700">å¯†ç¢¼</label><input type="password" id="loginPwd" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                    <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-orange-600 transition font-bold shadow-md text-lg">ç™»å…¥</button>
                </form>
                <form id="registerForm" onsubmit="handleAuth(event, 'register')" class="space-y-4 hidden">
                    <div class="bg-blue-50 p-4 rounded text-sm text-blue-800 mb-4 border-l-4 border-blue-500"><p class="font-bold">æ–°é€²äººå“¡è¨»å†Š</p><p>ç¬¬ä¸€ä½è¨»å†Šè€…å°‡è‡ªå‹•æˆç‚ºè€é—†ã€‚</p></div>
                    <div><label class="block text-sm font-bold mb-1 text-gray-700">å§“å</label><input type="text" id="regName" class="w-full p-3 border border-gray-300 rounded" required></div>
                    <div><label class="block text-sm font-bold mb-1 text-gray-700">è‡ªè¨‚å¸³è™Ÿ</label><input type="text" id="regId" class="w-full p-3 border border-gray-300 rounded" required></div>
                    <div><label class="block text-sm font-bold mb-1 text-gray-700">è‡ªè¨‚å¯†ç¢¼</label><input type="password" id="regPwd" class="w-full p-3 border border-gray-300 rounded" required></div>
                    <button type="submit" class="w-full bg-secondary text-black py-3 rounded hover:bg-blue-300 transition font-bold shadow-md">å»ºç«‹å¸³è™Ÿ</button>
                </form>
            </div>
        </div>

        <div id="ownerDashboard" class="hidden space-y-6 animate-fade-in">
            <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
                <h2 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-crown text-yellow-500 mr-2"></i>è€é—†å„€è¡¨æ¿</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-5 rounded-lg shadow border-l-4 border-secondary"><h3 class="text-gray-500 text-sm font-bold">ç¸½å®¶åº­æ•¸</h3><p class="text-4xl font-bold text-gray-800 mt-2" id="ownerTotalFamilies">0</p></div>
                <div class="bg-white p-5 rounded-lg shadow border-l-4 border-riskRed"><h3 class="text-gray-500 text-sm font-bold">é«˜é¢¨éšªå®¶åº­</h3><p class="text-4xl font-bold text-riskRed mt-2" id="ownerRiskCount">0</p></div>
                <div class="bg-white p-5 rounded-lg shadow border-l-4 border-primary relative">
                    <h3 class="text-gray-500 text-sm font-bold">ç•¶æœˆå£½æ˜Ÿ</h3>
                    <p class="text-4xl font-bold text-primary mt-2" id="ownerBirthdayCount">0</p>
                    <div id="ownerBirthdayList" class="mt-2 text-sm text-gray-800 font-bold bg-yellow-50 p-1 rounded h-12 overflow-y-auto scrollbar-thin border border-yellow-100">ç„¡</div>
                </div>
            </div>
            <div id="ownerHealthBoard" class="mb-6 p-4 rounded shadow-sm border-l-4 border-red-500 bg-red-50 hidden">
                <div class="flex items-center">
                    <div id="ownerHealthIcon" class="flex-shrink-0 text-2xl text-red-600"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <div class="ml-4 w-full">
                        <h3 id="ownerHealthTitle" class="text-lg font-bold text-red-800">è­¦ç¤ºï¼šåŠ å…¥æ»¿4å€‹æœˆä»æœªé•·é«˜</h3>
                        <div id="ownerStagnantList" class="text-sm mt-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-1 text-red-700 font-bold"></div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200"><h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2"><i class="fa-solid fa-chart-column mr-2"></i> å„ç®¡ç†å¸«-ç®¡ç†å®¶åº­å¹³å‡èº«é«˜</h3><div class="relative h-64"><canvas id="managerChart"></canvas></div></div>
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200"><h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2"><i class="fa-solid fa-chart-line mr-2"></i> å„åœ‹ç±-å¹³å‡ç”Ÿé•·å¹…åº¦</h3><div class="relative h-64"><canvas id="nationChart"></canvas></div></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-list"></i> å…¨æ©Ÿæ§‹å®¶åº­æ˜ç´°</h3>
                    <div class="w-full md:w-auto"><input type="text" id="familySearch" placeholder="ğŸ” æœå°‹å®¶é•·ã€å­©ç«¥ã€åœ‹ç±..." class="border p-2 rounded text-sm w-full md:w-64 focus:outline-none focus:border-primary shadow-inner" oninput="filterOwnerTable('search')"></div>
                </div>
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button onclick="filterOwnerTable('all')" class="bg-secondary text-black px-3 py-1 rounded text-sm whitespace-nowrap">å…¨éƒ¨</button>
                    <button onclick="filterOwnerTable('risk')" class="bg-riskRed text-white px-3 py-1 rounded text-sm whitespace-nowrap">é«˜é¢¨éšª</button>
                    <div id="nationFilters" class="flex gap-2"></div>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200"><table class="w-full text-left border-collapse"><thead><tr class="bg-gray-100 text-gray-700 text-sm"><th class="p-3">åœ‹ç±</th><th class="p-3">å®¶é•·å§“å</th><th class="p-3">å­©ç«¥/ç”Ÿæ—¥</th><th class="p-3">ç”Ÿé•·æ•¸æ“š</th><th class="p-3">è² è²¬ç®¡ç†å¸«</th><th class="p-3 text-primary">è² è²¬ç­ä¸»ä»»</th><th class="p-3 text-center">é¢¨éšª</th><th class="p-3 text-center">æ“ä½œ</th></tr></thead><tbody id="ownerFamilyTable" class="text-sm bg-white divide-y divide-gray-100 text-gray-800"></tbody></table></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                <h3 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2"><i class="fa-solid fa-users-gear"></i> äººå“¡æ¬Šé™ç®¡ç†èˆ‡ç­ä¸»ä»»åˆ†é…</h3>
                <div id="staffList" class="flex flex-col gap-3"></div>
            </div>
        </div>

        <div id="directorDashboard" class="hidden space-y-6">
            <div id="directorHealthBoard" class="mb-6 p-4 rounded shadow-sm border-l-4 border-red-500 bg-red-50 hidden">
                <div class="flex items-center">
                    <div id="directorHealthIcon" class="flex-shrink-0 text-2xl text-red-600"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <div class="ml-4 w-full">
                        <h3 id="directorHealthTitle" class="text-lg font-bold text-red-800">è­¦ç¤ºï¼šåŠ å…¥æ»¿4å€‹æœˆä»æœªé•·é«˜</h3>
                        <div id="directorStagnantList" class="text-sm mt-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-1 text-red-700 font-bold"></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4 border-l-4 border-primary">
                <div><h2 class="text-2xl font-bold text-gray-800">æˆ‘çš„ç®¡ç†å®¶åº­</h2><p class="text-gray-500 text-sm">è¦ªè‡ªè² è²¬çš„å€‹æ¡ˆç®¡ç†</p></div>
                <button onclick="openFamilyModal()" class="bg-primary text-white px-5 py-2 rounded-full shadow hover:bg-orange-600 font-bold flex items-center gap-2"><i class="fa-solid fa-plus"></i> æ–°å¢å®¶åº­</button>
            </div>
            <div id="directorMyFamilyList" class="flex flex-col gap-3 mb-8"></div>
             <div class="bg-yellow-100 border-l-4 border-primary text-yellow-800 p-4 rounded shadow-sm"><p class="font-bold">ç­ä¸»ä»»ç£å°æ¨¡å¼</p><p class="text-sm">åƒ…ä¾›æª¢è¦–æ——ä¸‹ç®¡ç†å¸«ç¸¾æ•ˆèˆ‡å®¶åº­ç‹€æ³ã€‚</p></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow h-fit border border-gray-200"><h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">æ——ä¸‹ç®¡ç†å¸«è¡¨ç¾</h3><div id="directorTeamList" class="space-y-3"></div></div>
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200"><h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">éœ€é—œæ³¨å®¶åº­ (ç´…/é»ƒç‡ˆ)</h3><div id="directorRiskList" class="space-y-3 max-h-[500px] overflow-y-auto"></div></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border border-gray-200"><h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">å…¨æ©Ÿæ§‹å®¶åº­è³‡æ–™åˆ—è¡¨</h3><div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-gray-100 text-gray-700 text-sm"><th class="p-3">åœ‹ç±</th><th class="p-3">å­©ç«¥/ç”Ÿæ—¥</th><th class="p-3">ç”Ÿé•·æ•¸æ“š</th><th class="p-3">è² è²¬äººå“¡</th><th class="p-3 text-center">é¢¨éšª</th><th class="p-3 text-center">æ“ä½œ</th></tr></thead><tbody id="directorFamilyTable" class="text-sm bg-white divide-y divide-gray-100 text-gray-800"></tbody></table></div></div>
        </div>

        <div id="managerDashboard" class="hidden space-y-6 animate-fade-in">
            <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
                <div><h2 class="text-2xl font-bold text-gray-800">æˆ‘çš„å®¶åº­ç®¡ç†</h2><p class="text-gray-500 text-sm">ç®¡ç†èˆ‡ç´€éŒ„å­©ç«¥ç”Ÿé•·æ›²ç·š</p></div>
                <button onclick="openFamilyModal()" class="bg-primary text-white px-5 py-2 rounded-full shadow hover:bg-orange-600 font-bold flex items-center gap-2"><i class="fa-solid fa-plus"></i> æ–°å¢å®¶åº­</button>
            </div>
            <div id="managerFamilyList" class="flex flex-col gap-3"></div>
        </div>
    </main>

    <div id="familyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 backdrop-blur-sm"><div class="bg-white rounded-xl w-full max-w-4xl shadow-2xl relative max-h-[90vh] overflow-y-auto border-t-8 border-primary"><button onclick="closeFamilyModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50"><i class="fa-solid fa-times text-xl"></i></button><div class="p-6 md:p-8"><h3 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">å®¶åº­è³‡æ–™</h3><form id="familyForm" onsubmit="saveFamily(event)" class="space-y-6 p-6"><input type="hidden" id="familyId"><div class="flex border-b border-gray-200 mb-4"><button type="button" onclick="switchModalTab('basic')" id="tab-basic" class="px-4 py-2 text-sm font-bold text-primary border-b-2 border-primary">åŸºæœ¬è³‡æ–™</button><button type="button" onclick="switchModalTab('records')" id="tab-records" class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-primary">ç´€éŒ„èˆ‡è¿½è¹¤</button></div><div id="content-basic" class="space-y-6"><div class="bg-gray-50 p-4 rounded border border-gray-200"><h4 class="font-bold text-gray-800 mb-3">å®¶é•·è³‡è¨Šèˆ‡åˆç´„ç‹€æ…‹</h4><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-xs font-bold text-primary uppercase mb-1">å®¶é•·å§“å</label><input type="text" id="parentName" class="w-full border p-2 rounded" required></div><div><label class="block text-xs font-bold text-primary uppercase mb-1">åœ‹ç±</label><input type="text" id="nationality" class="w-full border p-2 rounded" placeholder="è«‹å¡«å¯«ä¸­æ–‡" required></div><div><label class="block text-xs font-bold text-primary uppercase mb-1">åŠ å…¥/çºŒç´„æ—¥æœŸ</label><input type="date" id="joinDate" class="w-full border p-2 rounded bg-white focus:bg-white transition" max="9999-12-31"><p id="dateReminder" class="text-xs text-red-500 mt-1 hidden font-bold animate-pulse"><i class="fa-solid fa-circle-exclamation"></i> è«‹é‡æ–°è¨­å®šæ—¥æœŸï¼</p></div></div><div class="mt-3"><label class="block text-xs font-bold text-primary uppercase mb-1">å®¶åº­ç‹€æ³èªªæ˜ (é‡é»æé†’)</label><textarea id="familyNote" class="w-full border p-2 rounded h-20 placeholder-gray-400 text-sm" placeholder="ä¾‹å¦‚ï¼šå®¶é•·å·¥ä½œå¿™ç¢Œï¼Œéœ€æ™šä¸Šè¯ç¹«..."></textarea></div><div class="mt-3"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="isRenewal" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" onchange="toggleDateReminder()"><span class="ml-2 text-sm font-bold text-gray-700">æ­¤ç‚ºçºŒç´„å®¶åº­</span></label></div></div><div class="bg-infoBlue p-4 rounded border border-infoDark"><div class="flex justify-between items-center mb-3"><h4 class="font-bold text-gray-800"><i class="fa-solid fa-baby"></i> å­©ç«¥è³‡æ–™</h4><button type="button" onclick="addKidField()" id="btnAddKid" class="text-xs bg-white border border-infoDark text-infoDark px-2 py-1 rounded hover:bg-infoDark hover:text-white transition">+ æ–°å¢å­©ç«¥</button></div><div id="kidsContainer" class="space-y-3"></div></div></div><div id="content-records" class="hidden space-y-6"><div class="bg-yellow-50 p-4 rounded border border-yellow-200 mb-4 flex flex-col md:flex-row gap-4 justify-between items-center"><div class="w-full md:w-1/2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">é¸æ“‡å­©ç«¥</label><select id="recordKidSelect" class="w-full border p-2 rounded" onchange="renderKidLogs()"></select></div><div class="w-full md:w-1/2"><label class="block text-xs font-bold text-primary uppercase mb-1">æœ¬æœˆè©•ä¼°é¢¨éšª</label><div class="flex gap-2"><label class="flex-1 cursor-pointer border p-2 rounded text-center hover:bg-green-50 bg-white text-sm"><input type="radio" name="risk" value="green" class="mr-1" checked> <span class="text-riskGreen font-bold">ç©©å®š</span></label><label class="flex-1 cursor-pointer border p-2 rounded text-center hover:bg-yellow-50 bg-white text-sm"><input type="radio" name="risk" value="yellow" class="mr-1"> <span class="text-riskYellow font-bold">è§€å¯Ÿ</span></label><label class="flex-1 cursor-pointer border p-2 rounded text-center hover:bg-red-50 bg-white text-sm"><input type="radio" name="risk" value="red" class="mr-1"> <span class="text-riskRed font-bold">é«˜éšª</span></label></div></div></div><div class="bg-white p-4 rounded border border-gray-200 shadow-sm" id="logFormContainer"><h5 class="font-bold text-gray-800 mb-3 border-b pb-1">æ–°å¢/æ›´æ–°ç´€éŒ„</h5><div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3"><div><label class="text-xs text-gray-500">æ—¥æœŸ</label><input type="date" id="logDate" class="w-full border p-1 rounded text-sm" max="9999-12-31"></div><div><label class="text-xs text-gray-500">èº«é«˜ (cm)</label><div class="flex items-center gap-1"><input type="number" step="0.1" id="logHeight" class="w-full border p-1 rounded text-sm"><span id="heightTrend" class="text-[10px] font-bold w-12"></span></div></div><div><label class="text-xs text-gray-500">é«”é‡ (kg)</label><div class="flex items-center gap-1"><input type="number" step="0.1" id="logWeight" class="w-full border p-1 rounded text-sm"><span id="weightTrend" class="text-[10px] font-bold w-12"></span></div></div></div><div class="grid grid-cols-3 gap-3 mb-3"><div><label class="text-xs text-gray-500">æ¨æ‹¿ (æ¬¡)</label><input type="text" id="logMassage" class="w-full border p-1 rounded text-sm"></div><div><label class="text-xs text-gray-500">ç©´é“ (æ¬¡)</label><input type="text" id="logAcupoint" class="w-full border p-1 rounded text-sm"></div><div><label class="text-xs text-gray-500">é‹å‹• (æ¬¡)</label><input type="text" id="logExercise" class="w-full border p-1 rounded text-sm"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3"><div class="bg-orange-50 p-2 rounded border border-orange-100"><label class="text-xs text-gray-500 font-bold block mb-1">å¿Œå£æƒ…å½¢</label><div class="flex gap-2"><label class="flex items-center cursor-pointer"><input type="radio" name="diet" value="å¾ˆå¥½" class="text-primary focus:ring-primary mr-1"><span class="text-sm">å¾ˆå¥½</span></label><label class="flex items-center cursor-pointer"><input type="radio" name="diet" value="æ™®é€š" class="text-primary focus:ring-primary mr-1"><span class="text-sm">æ™®é€š</span></label><label class="flex items-center cursor-pointer"><input type="radio" name="diet" value="æ²’æœ‰" class="text-primary focus:ring-primary mr-1"><span class="text-sm">æ²’æœ‰</span></label></div></div><div class="bg-orange-50 p-2 rounded border border-orange-100"><label class="text-xs text-gray-500 font-bold block mb-1">å·²ç™¼é€ä¸­è—¥èŒ¶åŒ… (åŒ…)</label><select id="logTeaBags" class="w-full border p-1 rounded text-sm bg-white"><option value="">-- éå¿…å¡« --</option><option value="1">1åŒ…</option><option value="2">2åŒ…</option><option value="3">3åŒ…</option><option value="4">4åŒ…</option><option value="5">5åŒ…</option><option value="6">6åŒ…</option><option value="7">7åŒ…</option><option value="8">8åŒ…</option><option value="9">9åŒ…</option><option value="10">10åŒ…</option></select></div></div><div class="mb-3"><label class="text-xs text-gray-500">æœ¬æœˆç®¡ç†ç‹€æ³å›å ± (æ˜ç´°)</label><textarea id="logStatus" class="w-full border p-1 rounded text-sm h-16" placeholder="å¡«å¯«æœ¬æœˆç‹€æ³..."></textarea><textarea id="statusReport" class="hidden"></textarea></div><button type="button" onclick="saveLogDirectly()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 font-bold text-sm shadow"><i class="fa-solid fa-floppy-disk"></i> å„²å­˜ç´€éŒ„</button></div><div class="bg-white rounded border border-gray-200 overflow-hidden"><div class="bg-gray-100 p-2 font-bold text-xs text-gray-600">æ­·å²ç´€éŒ„æ˜ç´°</div><div id="logsHistoryTable" class="max-h-64 overflow-y-auto scrollbar-thin"></div></div></div><div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end" id="modalFooterBtn"><button type="submit" class="bg-secondary text-black px-8 py-3 rounded-lg font-bold text-lg shadow-lg hover:opacity-90 w-full md:w-auto">å„²å­˜åŸºæœ¬è³‡æ–™</button></div></form></div></div>

    <div id="transferModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 backdrop-blur-sm"><div class="bg-white rounded-xl w-full max-w-md shadow-2xl p-6 border-t-8 border-infoDark"><h3 id="transferModalTitle" class="text-xl font-bold mb-4 text-gray-800">ç§»äº¤å®¶åº­</h3><div class="mb-6"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">æ–°è² è²¬äºº</label><select id="targetManagerSelect" class="w-full border p-3 rounded bg-infoBlue focus:bg-white outline-none text-black"></select></div><div class="flex justify-end gap-3"><button onclick="document.getElementById('transferModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-bold">å–æ¶ˆ</button><button onclick="confirmTransfer()" class="px-4 py-2 bg-infoDark text-white rounded hover:bg-blue-700 font-bold shadow">ç¢ºèªç§»äº¤</button></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        function log(msg, type='info') { const box = document.getElementById('logContent'); if(!box) return; const time = new Date().toLocaleTimeString(); const colorClass = type === 'error' ? 'log-err' : (type === 'warn' ? 'log-warn' : (type === 'check' ? 'log-check' : 'log-info')); box.innerHTML += `<div class="${colorClass}">[${time}] ${msg}</div>`; document.getElementById('debugConsole').scrollTop = document.getElementById('debugConsole').scrollHeight; console.log(`[${type}] ${msg}`); }
        const firebaseConfig = { apiKey: "AIzaSyBS8RCrZArtOLddiTSK8zt5VD2ODuYxLoA", authDomain: "j-growth-app-new.firebaseapp.com", projectId: "j-growth-app-new", storageBucket: "j-growth-app-new.appspot.com", messagingSenderId: "573660567724", appId: "1:573660567724:web:f8464351a96e276112a709", measurementId: "G-TBE5PXCXWT" };
        let app, auth, db;
        try { app = firebase.initializeApp(firebaseConfig); auth = firebase.auth(); db = firebase.firestore(); log("Firebase åˆå§‹åŒ–æˆåŠŸï¼", "info"); } catch (e) { log("Firebase åˆå§‹åŒ–å¤±æ•—: " + e.message, "error"); }
        let currentUser = null, userData = null, allStaffCache = []; const FAKE_DOMAIN = "@growth.system"; let currentEditingFamily = null; let managerDirectorMap = {}; let undoTimeout = null; let pendingUndoAction = null;
        
        function toggleDateReminder() { const isChecked = document.getElementById('isRenewal').checked; const reminder = document.getElementById('dateReminder'); if (isChecked) reminder.classList.remove('hidden'); else reminder.classList.add('hidden'); }
        function switchAuthTab(tab) { document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login'); document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register'); document.getElementById('tab-login').classList.toggle('active', tab === 'login'); document.getElementById('tab-register').classList.toggle('active', tab === 'register'); }
        async function handleAuth(e, type) { e.preventDefault(); try { if (type === 'login') { await auth.signInWithEmailAndPassword(document.getElementById('loginId').value.trim() + FAKE_DOMAIN, document.getElementById('loginPwd').value); } else { const cred = await auth.createUserWithEmailAndPassword(document.getElementById('regId').value.trim() + FAKE_DOMAIN, document.getElementById('regPwd').value); const usersSnap = await db.collection('users').get(); await db.collection('users').doc(cred.user.uid).set({ name: document.getElementById('regName').value.trim(), username: document.getElementById('regId').value.trim(), role: usersSnap.empty ? 'owner' : 'manager', createdAt: new Date() }); alert('è¨»å†ŠæˆåŠŸ'); } } catch (err) { alert("éŒ¯èª¤: " + err.message); } }
        auth.onAuthStateChanged(async (user) => { if (user) { try { const doc = await db.collection('users').doc(user.uid).get(); if (doc.exists) { userData = doc.data(); currentUser = user; document.getElementById('authSection').classList.add('hidden'); document.getElementById('navUser').classList.remove('hidden'); document.getElementById('navUser').classList.add('flex'); document.getElementById('userRoleDisplay').innerText = userData.role === 'owner' ? 'è€é—†' : (userData.role === 'director' ? 'ç­ä¸»ä»»' : 'ç®¡ç†å¸«'); document.getElementById('userNameDisplay').innerText = userData.name; if (userData.role === 'owner') { initOwnerDashboard(); document.getElementById('ownerDashboard').classList.remove('hidden'); } else if (userData.role === 'director') { initDirectorDashboard(); document.getElementById('directorDashboard').classList.remove('hidden'); } else { initManagerDashboard(); document.getElementById('managerDashboard').classList.remove('hidden'); } } else { alert("æŸ¥ç„¡ä½¿ç”¨è€…è³‡æ–™"); auth.signOut(); } } catch (error) { auth.signOut(); } } else { document.getElementById('authSection').classList.remove('hidden'); document.getElementById('navUser').classList.add('hidden'); ['ownerDashboard','directorDashboard','managerDashboard'].forEach(id => document.getElementById(id).classList.add('hidden')); } });
        function logout() { auth.signOut(); location.reload(); }
        function showUndoToast(message, undoCallback) { const toast = document.getElementById('undoToast'); document.getElementById('undoMessage').innerText = message; toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('show'), 10); pendingUndoAction = undoCallback; if (undoTimeout) clearTimeout(undoTimeout); undoTimeout = setTimeout(() => { closeToast(); }, 5000); }
        function closeToast() { const toast = document.getElementById('undoToast'); toast.classList.remove('show'); setTimeout(() => toast.classList.add('hidden'), 300); pendingUndoAction = null; }
        function executeUndo() { if (pendingUndoAction) { pendingUndoAction(); closeToast(); } }
        function getLatestLog(kid) { if (!kid.logs || kid.logs.length === 0) return null; const sorted = [...kid.logs].sort((a, b) => { const da = a.date || a.month || ''; const db = b.date || b.month || ''; return da.localeCompare(db); }); return sorted[sorted.length - 1]; }
        
        function checkGrowthStagnation(kid, joinDateStr) { 
            let startDate = new Date();
            if (joinDateStr) {
                startDate = new Date(joinDateStr);
            } else if (kid.logs && kid.logs.length > 0) {
                 const sorted = [...kid.logs].sort((a,b) => (a.date||'').localeCompare(b.date||''));
                 startDate = new Date(sorted[0].date);
            } else {
                 return false; 
            }

            const today = new Date();
            const fourMonthsThreshold = new Date(startDate);
            fourMonthsThreshold.setMonth(fourMonthsThreshold.getMonth() + 4);

            if (today < fourMonthsThreshold) {
                log(`[è§€å¯ŸæœŸ] ${kid.name}: åŠ å…¥æœªæ»¿4å€‹æœˆ (${startDate.toISOString().split('T')[0]})ï¼Œæš«ä¸è­¦ç¤ºã€‚`, 'check');
                return false;
            }

            if (!kid.logs || kid.logs.length === 0) return false;
            
            const sortedLogs = kid.logs.map(l => {
                const d = new Date(l.date || l.month + "-01");
                return { ...l, ts: d.getTime() };
            }).sort((a, b) => a.ts - b.ts);
            
            const latestLog = sortedLogs[sortedLogs.length - 1]; 
            const latestHeight = Number(latestLog.height);
            const initialHeight = Number(kid.initialHeight || 0);

            const isStagnant = latestHeight <= initialHeight;

            if (isStagnant) {
                log(`[è­¦ç¤º] ${kid.name}: åŠ å…¥å·²æ»¿4å€‹æœˆï¼Œèº«é«˜æœªæˆé•· (åˆå§‹:${initialHeight} -> æœ€æ–°:${latestHeight})`, 'error');
            }
            
            return isStagnant;
        }
        
        function testAlertSystem() {
            const alertList = document.getElementById('ownerStagnantList');
            const board = document.getElementById('ownerHealthBoard');
            if (board.classList.contains('hidden')) {
                board.classList.remove('hidden');
                document.getElementById('ownerHealthTitle').innerText = "è­¦ç¤ºï¼šåŠ å…¥æ»¿4å€‹æœˆä»æœªé•·é«˜";
                alertList.innerHTML = `<div class="bg-white p-2 rounded shadow-sm border border-red-200 flex justify-between"><span>æ¸¬è©¦å­©ç«¥A</span> <span class="text-xs text-gray-500">Manager1</span></div>`;
            } else {
                board.classList.add('hidden');
            }
        }

        // ... (initManagerDashboard, switchModalTab, addKidField, removeKidField, renderKidSelectOptions same as V17.1) ...
        function initManagerDashboard() { const container = document.getElementById('managerFamilyList'); db.collection('families').where('managerId', '==', currentUser.uid).onSnapshot(snap => { container.innerHTML = snap.empty ? '<div class="col-span-3 text-center bg-white p-10 rounded border text-gray-500 shadow">å°šç„¡è³‡æ–™ï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ã€‚</div>' : ''; snap.forEach(doc => { const d = doc.data(); const kidNames = d.kids ? d.kids.map(k => k.name).join(', ') : 'ç„¡å­©ç«¥'; const k1 = d.kids && d.kids.length > 0 ? d.kids[0] : null; let lastInfo = 'ç„¡ç´€éŒ„'; let growthStr = ''; if (k1) { const latest = getLatestLog(k1); const lastH = latest ? latest.height : k1.initialHeight; const lastDate = latest ? (latest.date || latest.month) : 'åˆå§‹'; lastInfo = `æœ€æ–°: ${lastDate} / èº«é«˜ ${lastH}cm`; const growth = (Number(lastH) - Number(k1.initialHeight || 0)).toFixed(1); growthStr = `<span class="text-green-600 font-bold">(+${growth})</span>`; } const riskClass = getRiskClass(d.riskLevel); const riskLabel = getRiskLabel(d.riskLevel); const borderClass = d.riskLevel === 'red' ? 'border-riskRed' : (d.riskLevel === 'yellow' ? 'border-riskYellow' : 'border-riskGreen'); container.innerHTML += `<div class="bg-white p-4 rounded shadow border-l-4 ${borderClass} hover:shadow-lg transition flex flex-col md:flex-row items-center justify-between gap-4 w-full relative"><div class="flex-grow w-full md:w-auto cursor-pointer" onclick="openFamilyModal('${doc.id}', 'records')"><div class="flex items-center flex-wrap gap-2 mb-1"><h3 class="font-bold text-lg text-gray-800">${d.parentName}</h3><span class="text-xs px-2 py-1 bg-gray-100 rounded text-gray-600">${d.nationality}</span><span class="text-xs px-2 py-1 rounded font-bold ${riskClass}">${riskLabel}</span></div><div class="text-sm text-gray-600 flex flex-wrap gap-4 items-center"><span><i class="fa-solid fa-child text-accent"></i> ${kidNames}</span><span class="text-gray-500">${lastInfo} ${growthStr}</span></div></div><div class="flex items-center gap-3 w-full md:w-auto justify-end z-10"><div class="text-xs text-gray-500 bg-gray-50 p-2 rounded truncate max-w-[150px] hidden lg:block border border-gray-100" title="${d.statusReport || ''}"><i class="fa-solid fa-comment-dots"></i> ${d.statusReport || 'ç„¡å›å ±'}</div><button onclick="event.stopPropagation(); openFamilyModal('${doc.id}', 'basic');" class="bg-white border border-secondary text-black px-4 py-2 rounded hover:bg-secondary hover:text-white transition text-sm font-bold whitespace-nowrap flex items-center gap-1"><i class="fa-solid fa-pen-to-square"></i> ç·¨è¼¯è³‡æ–™</button><button onclick="event.stopPropagation(); deleteFamily('${doc.id}', '${d.parentName}')" class="text-red-400 hover:text-red-600 px-2 transition" title="åˆªé™¤å®¶åº­"><i class="fa-solid fa-trash"></i></button></div></div>`; }); }); }
        function switchModalTab(tabName) { document.getElementById('content-basic').classList.toggle('hidden', tabName !== 'basic'); document.getElementById('content-records').classList.toggle('hidden', tabName !== 'records'); const tBasic = document.getElementById('tab-basic'), tRec = document.getElementById('tab-records'); const footerBtn = document.getElementById('modalFooterBtn'); if(tabName === 'basic') { tBasic.classList.add('text-primary', 'border-b-2', 'border-primary'); tBasic.classList.remove('text-gray-500'); tRec.classList.remove('text-primary', 'border-b-2', 'border-primary'); tRec.classList.add('text-gray-500'); if(footerBtn) footerBtn.style.display = 'flex'; } else { tRec.classList.add('text-primary', 'border-b-2', 'border-primary'); tRec.classList.remove('text-gray-500'); tBasic.classList.remove('text-primary', 'border-b-2', 'border-primary'); tBasic.classList.add('text-gray-500'); if(footerBtn) footerBtn.style.display = 'none'; renderKidSelectOptions(); } }
        function addKidField(data = null) { const container = document.getElementById('kidsContainer'); const kidHtml = `<div class="grid grid-cols-1 md:grid-cols-6 gap-2 bg-white p-2 rounded border border-gray-200 mb-2 kid-entry items-end"><div class="md:col-span-1"><label class="text-[10px] text-gray-400">å§“å</label><input type="text" class="kid-name w-full border p-1 text-sm rounded" value="${data ? data.name : ''}" required></div><div class="md:col-span-1"><label class="text-[10px] text-gray-400">ç”Ÿæ—¥</label><input type="date" class="kid-dob w-full border p-1 text-sm rounded" value="${data ? data.dob : ''}" max="9999-12-31" required></div><div class="md:col-span-1"><label class="text-[10px] text-gray-400">åˆå§‹èº«é«˜</label><input type="number" step="0.1" class="kid-h w-full border p-1 text-sm rounded" value="${data ? data.initialHeight : ''}" placeholder="cm" required></div><div class="md:col-span-1"><label class="text-[10px] text-gray-400">åˆå§‹é«”é‡</label><input type="number" step="0.1" class="kid-w w-full border p-1 text-sm rounded" value="${data ? data.initialWeight : ''}" placeholder="kg" required></div><div class="md:col-span-1"><label class="text-[10px] text-gray-400">éª¨é½¡</label><input type="number" step="0.1" class="kid-bone w-full border p-1 text-sm rounded" value="${data ? data.boneAge || '' : ''}"></div><div class="md:col-span-1 text-right"><button type="button" onclick="removeKidField(this)" class="text-red-500 hover:text-red-700" title="åˆªé™¤ (å¯å¾©åŸ)"><i class="fa-solid fa-trash"></i></button></div></div>`; container.insertAdjacentHTML('beforeend', kidHtml); }
        function removeKidField(btn) { const row = btn.closest('.kid-entry'); if (row.classList.contains('marked-for-deletion')) { row.classList.remove('marked-for-deletion'); btn.innerHTML = '<i class="fa-solid fa-trash"></i>'; btn.classList.replace('text-green-600', 'text-red-500'); } else { row.classList.add('marked-for-deletion'); btn.innerHTML = '<i class="fa-solid fa-rotate-left"></i>'; btn.classList.replace('text-red-500', 'text-green-600'); } }
        function renderKidSelectOptions() { const select = document.getElementById('recordKidSelect'); select.innerHTML = ''; const inputs = document.querySelectorAll('.kid-entry:not(.marked-for-deletion)'); inputs.forEach((div, idx) => { const name = div.querySelector('.kid-name').value || `å­©ç«¥ ${idx+1}`; const opt = document.createElement('option'); opt.value = idx; opt.text = name; select.appendChild(opt); }); renderKidLogs(); }
        function renderKidLogs() {
            const kidIdx = document.getElementById('recordKidSelect').value; const table = document.getElementById('logsHistoryTable'); table.innerHTML = '';
            let logs = [];
            if (currentEditingFamily && currentEditingFamily.kids[kidIdx]) {
                logs = currentEditingFamily.kids[kidIdx].logs || [];
                const initH = Number(currentEditingFamily.kids[kidIdx].initialHeight || 0);
                const initW = Number(currentEditingFamily.kids[kidIdx].initialWeight || 0);
                if (logs.length === 0) { table.innerHTML = '<p class="text-center text-xs text-gray-400 p-2">ç„¡æ­·å²ç´€éŒ„</p>'; } else {
                    const sorted = [...logs].sort((a,b) => { const da = a.date || a.month || ''; const db = b.date || b.month || ''; return da.localeCompare(db); });
                    let html = '<table class="w-full text-xs text-left"><thead class="bg-gray-50"><tr><th class="p-1">æ—¥æœŸ</th><th class="p-1">èº«é«˜(è¶¨å‹¢)</th><th class="p-1">é«”é‡(è¶¨å‹¢)</th><th class="p-1">ç‹€æ…‹</th><th class="p-1">èŒ¶åŒ…</th><th class="p-1">æ“ä½œ</th></tr></thead><tbody>';
                    for(let i = sorted.length - 1; i >= 0; i--) {
                        const l = sorted[i];
                        let prevH = initH, prevW = initW;
                        // Find previous log (closest earlier date)
                        for(let j = i - 1; j >= 0; j--) { prevH = Number(sorted[j].height); prevW = Number(sorted[j].weight); break; }
                        
                        const diffH = (Number(l.height) - prevH).toFixed(1); const diffW = (Number(l.weight) - prevW).toFixed(1);
                        const hClass = diffH > 0 ? 'text-green-600' : (diffH < 0 ? 'text-red-500' : 'text-gray-400'); const wClass = diffW > 0 ? 'text-green-600' : (diffW < 0 ? 'text-red-500' : 'text-gray-400');
                        const displayDate = l.date || l.month; const originalIndex = logs.indexOf(l);
                        html += `<tr class="border-b hover:bg-yellow-50"><td class="p-1">${displayDate}</td><td class="p-1 font-bold">${l.height} <span class="${hClass} text-[10px]">(${diffH>0?'+':''}${diffH})</span></td><td class="p-1">${l.weight} <span class="${wClass} text-[10px]">(${diffW>0?'+':''}${diffW})</span></td><td class="p-1 truncate max-w-[100px]">${l.statusReport||'-'}</td><td class="p-1">${l.teaBags ? l.teaBags+'åŒ…' : '-'}</td><td class="p-1 flex gap-1"><button type="button" onclick="editLog(${originalIndex})" class="text-blue-500 hover:text-blue-700"><i class="fa-solid fa-pen"></i></button><button type="button" onclick="deleteLog(${originalIndex})" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                    }
                    html += '</tbody></table>';
                    table.innerHTML = html;
                }
            }
        }
        
        function editLog(index) { const kidIdx = document.getElementById('recordKidSelect').value; const log = currentEditingFamily.kids[kidIdx].logs[index]; document.getElementById('logDate').value = log.date || ''; document.getElementById('logHeight').value = log.height; document.getElementById('logWeight').value = log.weight; document.getElementById('logMassage').value = log.massage || ''; document.getElementById('logAcupoint').value = log.acupoint || ''; document.getElementById('logExercise').value = log.exercise || ''; document.getElementById('logStatus').value = log.statusReport || ''; 
            // å¸¶å…¥èŒ¶åŒ…
            document.getElementById('logTeaBags').value = log.teaBags || '';
            // å¸¶å…¥å¿Œå£æƒ…å½¢ (Radio)
            const dietRadios = document.querySelectorAll('input[name="diet"]');
            dietRadios.forEach(r => r.checked = false);
            if(log.diet) {
                const r = document.querySelector(`input[name="diet"][value="${log.diet}"]`);
                if(r) r.checked = true;
            }

            // â˜… è¶¨å‹¢é è¦½è¨ˆç®— (Edit Mode) â˜…
            const prevH = currentEditingFamily.kids[kidIdx].initialHeight;
            const diffH = (Number(log.height) - Number(prevH)).toFixed(1);
            document.getElementById('heightTrend').innerText = diffH > 0 ? `+${diffH}` : diffH;
            document.getElementById('heightTrend').className = diffH > 0 ? 'text-[10px] font-bold w-12 text-green-600' : 'text-[10px] font-bold w-12 text-red-500';
            alert("è³‡æ–™å·²å¸¶å…¥ä¸Šæ–¹è¼¸å…¥æ¡†ï¼Œä¿®æ”¹å¾Œè«‹æŒ‰ã€Œå„²å­˜ç´€éŒ„ã€å³å¯è¦†è“‹ã€‚"); 
        }
        
        // â˜… å³æ™‚è¶¨å‹¢é è¦½ (Input Event) â˜…
        document.getElementById('logHeight').addEventListener('input', function() {
             const kidIdx = document.getElementById('recordKidSelect').value;
             if (currentEditingFamily && currentEditingFamily.kids[kidIdx]) {
                 const currentVal = this.value;
                 // ç°¡å–®æŠ“åˆå§‹å€¼æ¯”è¼ƒï¼Œè‹¥è¦æ›´ç²¾ç´°å¯æŠ“ä¸Šä¸€ç­† log
                 const initH = currentEditingFamily.kids[kidIdx].initialHeight;
                 if(currentVal && initH) {
                     const diff = (currentVal - initH).toFixed(1);
                     const span = document.getElementById('heightTrend');
                     span.innerText = diff > 0 ? `+${diff}` : diff;
                     span.className = diff > 0 ? 'text-[10px] font-bold w-12 text-green-600' : 'text-[10px] font-bold w-12 text-red-500';
                 }
             }
        });
        document.getElementById('logWeight').addEventListener('input', function() {
             const kidIdx = document.getElementById('recordKidSelect').value;
             if (currentEditingFamily && currentEditingFamily.kids[kidIdx]) {
                 const currentVal = this.value;
                 const initW = currentEditingFamily.kids[kidIdx].initialWeight;
                 if(currentVal && initW) {
                     const diff = (currentVal - initW).toFixed(1);
                     const span = document.getElementById('weightTrend');
                     span.innerText = diff > 0 ? `+${diff}` : diff;
                     span.className = diff > 0 ? 'text-[10px] font-bold w-12 text-green-600' : 'text-[10px] font-bold w-12 text-red-500';
                 }
             }
        });

        async function deleteLog(index) { const kidIdx = document.getElementById('recordKidSelect').value; const deletedLog = currentEditingFamily.kids[kidIdx].logs[index]; currentEditingFamily.kids[kidIdx].logs.splice(index, 1); try { await db.collection('families').doc(currentEditingFamily.id).update({ kids: currentEditingFamily.kids, updatedAt: new Date() }); renderKidLogs(); showUndoToast('å·²åˆªé™¤ä¸€ç­†ç´€éŒ„', async () => { currentEditingFamily.kids[kidIdx].logs.push(deletedLog); currentEditingFamily.kids[kidIdx].logs.sort((a,b) => (a.date||'').localeCompare(b.date||'')); await db.collection('families').doc(currentEditingFamily.id).update({ kids: currentEditingFamily.kids, updatedAt: new Date() }); renderKidLogs(); closeToast(); }); } catch(e) { alert("åˆªé™¤å¤±æ•—: " + e.message); } }
        async function saveLogDirectly() { if (!currentEditingFamily || !currentEditingFamily.id) { alert("è«‹å…ˆå„²å­˜å®¶åº­åŸºæœ¬è³‡æ–™"); return; } const kidIdx = document.getElementById('recordKidSelect').value; 
            
            // å–å¾—æ–°æ¬„ä½å€¼
            const dietVal = document.querySelector('input[name="diet"]:checked') ? document.querySelector('input[name="diet"]:checked').value : '';
            const teaVal = document.getElementById('logTeaBags').value;

            const newLog = { 
                date: document.getElementById('logDate').value, 
                height: document.getElementById('logHeight').value, 
                weight: document.getElementById('logWeight').value, 
                massage: document.getElementById('logMassage').value, 
                acupoint: document.getElementById('logAcupoint').value, 
                exercise: document.getElementById('logExercise').value, 
                statusReport: document.getElementById('logStatus').value, 
                diet: dietVal, // æ–°å¢
                teaBags: teaVal, // æ–°å¢
                recordedAt: new Date().toISOString() 
            }; 
            
            if (!newLog.date || !newLog.height) { alert("æ—¥æœŸèˆ‡èº«é«˜å¿…å¡«"); return; } if (!currentEditingFamily.kids[kidIdx].logs) currentEditingFamily.kids[kidIdx].logs = []; const existingIdx = currentEditingFamily.kids[kidIdx].logs.findIndex(l => l.date === newLog.date); if (existingIdx > -1) currentEditingFamily.kids[kidIdx].logs[existingIdx] = newLog; else currentEditingFamily.kids[kidIdx].logs.push(newLog); const risk = document.querySelector('input[name="risk"]:checked').value; currentEditingFamily.riskLevel = risk; currentEditingFamily.statusReport = newLog.statusReport; try { await db.collection('families').doc(currentEditingFamily.id).update({ kids: currentEditingFamily.kids, riskLevel: risk, statusReport: newLog.statusReport, updatedAt: new Date() }); alert("ç´€éŒ„å·²å„²å­˜ï¼"); 
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('logHeight').value = ''; 
            document.getElementById('logStatus').value = ''; 
            document.getElementById('logTeaBags').value = '';
            const dietRadios = document.querySelectorAll('input[name="diet"]');
            dietRadios.forEach(r => r.checked = false);

            renderKidLogs(); } catch (e) { alert("å„²å­˜å¤±æ•—: " + e.message); } }
        async function deleteFamily(id, name) { if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`)) { try { await db.collection('families').doc(id).delete(); } catch(e) { alert("åˆªé™¤å¤±æ•—: " + e.message); } } }
        
        // ... (Modal logic same as before) ...
        function openFamilyModal(id = null, initialTab = 'basic') { document.getElementById('familyForm').reset(); document.getElementById('familyId').value = id || ''; document.getElementById('modalTitle').innerText = id ? (userData.role === 'owner' ? 'è³‡æ–™è©³æƒ…' : 'ç·¨è¼¯è³‡æ–™') : 'æ–°å¢è³‡æ–™'; document.getElementById('kidsContainer').innerHTML = ''; switchModalTab(initialTab); const isReadOnly = userData.role === 'director'; let isEditAllowed = true; if (id) { db.collection('families').doc(id).get().then(doc => { const d = doc.data(); currentEditingFamily = { id: doc.id, ...d }; if (isReadOnly && d.managerId !== currentUser.uid) { isEditAllowed = false; } document.getElementById('parentName').value = d.parentName; document.getElementById('nationality').value = d.nationality; document.getElementById('joinDate').value = d.joinDate || ''; document.getElementById('familyNote').value = d.familyNote || ''; document.getElementById('logDate').value = new Date().toISOString().split('T')[0]; if (d.kids && d.kids.length > 0) { d.kids.forEach(kid => addKidField(kid)); } else { addKidField(); } if(d.riskLevel) { const radio = document.querySelector(`input[name="risk"][value="${d.riskLevel}"]`); if(radio) radio.checked = true; } if(document.getElementById('statusReport')) document.getElementById('statusReport').value = d.statusReport || ''; document.getElementById('isRenewal').checked = d.isRenewal || false; toggleDateReminder(); applyReadOnlyState(!isEditAllowed); }); } else { currentEditingFamily = { kids: [] }; addKidField(); document.getElementById('logDate').value = new Date().toISOString().split('T')[0]; document.getElementById('isRenewal').checked = false; toggleDateReminder(); applyReadOnlyState(false); } document.getElementById('familyModal').classList.remove('hidden'); }
        function applyReadOnlyState(isReadOnly) { const formInputs = document.querySelectorAll('#familyForm input, #familyForm select, #familyForm textarea'); formInputs.forEach(el => el.disabled = isReadOnly); const footerBtn = document.getElementById('modalFooterBtn'); if(footerBtn) footerBtn.style.display = isReadOnly ? 'none' : 'flex'; const addKidBtn = document.getElementById('btnAddKid'); if(addKidBtn) addKidBtn.style.display = isReadOnly ? 'none' : 'block'; const logFormContainer = document.getElementById('logFormContainer'); if(logFormContainer) logFormContainer.style.display = isReadOnly ? 'none' : 'block'; document.querySelectorAll('.kid-entry button').forEach(btn => btn.style.display = isReadOnly ? 'none' : 'block'); }
        function closeFamilyModal() { document.getElementById('familyModal').classList.add('hidden'); closeToast(); }
        async function saveFamily(e) { e.preventDefault(); const id = document.getElementById('familyId').value; const baseData = { parentName: document.getElementById('parentName').value, nationality: document.getElementById('nationality').value, joinDate: document.getElementById('joinDate').value, familyNote: document.getElementById('familyNote').value, riskLevel: document.querySelector('input[name="risk"]:checked').value, statusReport: document.getElementById('statusReport').value, isRenewal: document.getElementById('isRenewal').checked, updatedAt: new Date() }; const kidDivs = document.querySelectorAll('.kid-entry:not(.marked-for-deletion)'); const kidsData = []; kidDivs.forEach((div, idx) => { const name = div.querySelector('.kid-name').value; const dob = div.querySelector('.kid-dob').value; const h = div.querySelector('.kid-h').value; const w = div.querySelector('.kid-w').value; const bone = div.querySelector('.kid-bone').value; let existingLogs = []; if (currentEditingFamily && currentEditingFamily.kids) { const match = currentEditingFamily.kids.find(k => k.name === name && k.dob === dob); if(match) existingLogs = match.logs || []; } kidsData.push({ name: name, dob: dob, initialHeight: h, initialWeight: w, boneAge: bone, logs: existingLogs }); }); baseData.kids = kidsData; try { if (id) { await db.collection('families').doc(id).update(baseData); } else { baseData.managerId = currentUser.uid; baseData.managerName = userData.name; baseData.createdAt = new Date(); await db.collection('families').add(baseData); } closeFamilyModal(); } catch (err) { alert("å„²å­˜å¤±æ•—: " + err.message); } }
        async function assignDirector(managerId, directorId) { const directorName = directorId ? document.querySelector(`#dir_opt_${managerId}_${directorId}`).innerText : null; try { await db.collection('users').doc(managerId).update({ directorId: directorId || null, directorName: directorName || null }); alert("ç­ä¸»ä»»åˆ†é…æ›´æ–°æˆåŠŸï¼"); } catch (e) { alert("åˆ†é…å¤±æ•—: " + e.message); } }

        async function initOwnerDashboard() {
            let families = [];
            db.collection('families').onSnapshot(snap => {
                families = []; snap.forEach(d => { if(d.data().kids && d.data().kids.length > 0) families.push({id: d.id, ...d.data()}); });
                updateOwnerStats(families); updateCharts(families);
            }, err => log("Error: " + err.message, "error"));
            
            db.collection('users').onSnapshot(snap => {
                const div = document.getElementById('staffList'); div.innerHTML = ''; allStaffCache = [];
                const directors = []; const managers = [];
                snap.forEach(doc => {
                    const u = doc.data();
                    if(u.role === 'director') directors.push({id: doc.id, name: u.name});
                    if(u.role === 'manager') managers.push({id: doc.id, ...u});
                    if(u.role !== 'owner') allStaffCache.push({id: doc.id, name: u.name});
                });
                managerDirectorMap = {};
                managers.forEach(m => { if(m.id) managerDirectorMap[m.id] = m.directorName; });
                if(families.length > 0) filterOwnerTable('all', null, families);
                
                managers.forEach(m => {
                    let dirOptions = `<option value="">æœªåˆ†é…</option>`;
                    directors.forEach(d => { const selected = m.directorId === d.id ? 'selected' : ''; dirOptions += `<option id="dir_opt_${m.id}_${d.id}" value="${d.id}" ${selected}>${d.name}</option>`; });
                    const myFamilies = families.filter(f => f.managerId === m.id);
                    let avgHeight = 0;
                    if (myFamilies.length > 0) { 
                        let totalH = 0; let count = 0;
                        myFamilies.forEach(f => { 
                            if(f.kids) f.kids.forEach(k => {
                                const latest = getLatestLog(k);
                                const h = latest ? latest.height : k.initialHeight; 
                                totalH += Number(h); count++;
                            });
                        }); 
                        avgHeight = count ? (totalH / count).toFixed(1) : 0; 
                    }
                    div.innerHTML += `
                    <div class="bg-white p-4 rounded border shadow-sm flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="w-full md:w-1/4">
                            <div class="flex items-center gap-2">
                                <p class="font-bold text-gray-800 text-lg">${m.name}</p>
                                <span class="text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-600 border border-gray-200">ç®¡ç†å¸«</span>
                            </div>
                            <p class="text-xs text-gray-400">${m.username}</p>
                            <p class="text-sm mt-1 text-gray-600">å¹³å‡èº«é«˜: <b class="text-primary">${avgHeight}</b> cm</p>
                        </div>
                        
                        <div class="w-full md:w-1/3 flex items-center gap-2 bg-gray-50 p-2 rounded border border-gray-100">
                            <label class="text-xs text-gray-500 font-bold whitespace-nowrap">ç£å°:</label>
                            <select onchange="assignDirector('${m.id}', this.value)" class="text-sm border-none bg-transparent w-full focus:ring-0 cursor-pointer text-gray-700 font-bold outline-none">
                                ${dirOptions}
                            </select>
                        </div>

                        <div class="w-full md:w-auto flex gap-2 justify-end">
                            <button onclick="openTransferModal('${m.id}','${m.name}')" class="text-sm bg-blue-50 text-blue-600 px-3 py-2 rounded hover:bg-blue-100 font-bold transition whitespace-nowrap"><i class="fa-solid fa-right-left"></i> ç§»äº¤</button>
                            <button onclick="changeRole('${m.id}', 'director')" class="text-sm bg-green-50 text-green-600 px-3 py-2 rounded hover:bg-green-100 font-bold transition whitespace-nowrap">å‡é·</button>
                            <button onclick="deleteStaff('${m.id}')" class="text-sm bg-red-50 text-red-600 px-3 py-2 rounded hover:bg-red-100 font-bold transition whitespace-nowrap"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
                });

                directors.forEach(d => { 
                    div.innerHTML += `
                    <div class="bg-yellow-50 p-4 rounded border border-yellow-200 shadow-sm flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="w-full md:w-1/4">
                            <div class="flex items-center gap-2">
                                <p class="font-bold text-gray-800 text-lg">${d.name} <i class="fa-solid fa-star text-yellow-500 text-xs"></i></p>
                                <span class="text-xs px-2 py-0.5 rounded bg-primary text-white">ç­ä¸»ä»»</span>
                            </div>
                        </div>
                        <div class="w-full md:w-1/3 text-center text-xs text-gray-500 italic">
                            (ç­ä¸»ä»»ç®¡ç†æ¬Šé™)
                        </div>
                        <div class="w-full md:w-auto flex gap-2 justify-end">
                            <button onclick="changeRole('${d.id}', 'manager')" class="text-sm bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300 font-bold transition whitespace-nowrap">é™è·</button>
                            <button onclick="deleteStaff('${d.id}')" class="text-sm bg-red-50 text-red-600 px-3 py-2 rounded hover:bg-red-100 font-bold transition whitespace-nowrap"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`; 
                });
            }, err => log("è€é—†å“¡å·¥è¼‰å…¥éŒ¯èª¤: " + err.message, "error"));
        }
        
        async function changeRole(uid, newRole) { if(confirm(`ç¢ºå®šè¦è®Šæ›´æ¬Šé™ç‚º ${newRole === 'director' ? 'ç­ä¸»ä»»' : 'ç®¡ç†å¸«'} å—ï¼Ÿ`)) { try { await db.collection('users').doc(uid).update({ role: newRole }); alert("æ¬Šé™è®Šæ›´æˆåŠŸï¼"); } catch (e) { alert("è®Šæ›´å¤±æ•—: " + e.message); } } }
        async function deleteStaff(uid) { if(confirm("ç¢ºå®šç§»é™¤æ­¤å“¡å·¥ï¼Ÿ")) { try { await db.collection('users').doc(uid).delete(); alert("å“¡å·¥å·²ç§»é™¤"); } catch (e) { alert("ç§»é™¤å¤±æ•—: " + e.message); } } }

        function updateOwnerStats(families) {
            document.getElementById('ownerTotalFamilies').innerText = families.length;
            let stats = { total: 0, risk: 0, totalGrowth: 0, kidCount: 0, bday: 0 };
            const todayMonth = new Date().getMonth(); let bdayNames = [];
            const nations = [...new Set(families.map(f => f.nationality))];
            const nationDiv = document.getElementById('nationFilters'); nationDiv.innerHTML = '';
            nations.forEach(n => { nationDiv.innerHTML += `<button onclick="filterOwnerTable('nation', '${n}', window.currentFamilies)" class="bg-secondary text-black px-3 py-1 rounded text-sm whitespace-nowrap hover:opacity-80 transition">${n}</button>`; });
            window.currentFamilies = families;
            
            const alertList = document.getElementById('ownerStagnantList');
            const alertSection = document.getElementById('ownerHealthBoard');
            alertList.innerHTML = '';
            let alertCount = 0;

            families.forEach(f => {
                stats.total++;
                if(f.riskLevel === 'red') stats.risk++;
                if (f.kids) {
                    f.kids.forEach(k => {
                        if (k.dob) {
                            const parts = k.dob.split('-');
                            if (parts.length === 3) {
                                const bMonth = parseInt(parts[1]) - 1; 
                                if (bMonth === todayMonth) { stats.bday++; bdayNames.push(`${k.name} (${f.managerName || 'æœªåˆ†é…'})`); }
                            }
                        }
                        const latest = getLatestLog(k);
                        const currentH = latest ? latest.height : k.initialHeight;
                        const grow = Number(currentH) - Number(k.initialHeight || 0);
                        stats.totalGrowth += grow;
                        stats.kidCount++;

                        if(checkGrowthStagnation(k, f.joinDate)) {
                            alertCount++;
                            alertList.innerHTML += `<div class="bg-white p-2 rounded shadow-sm border border-red-200 flex justify-between"><span>${k.name}</span> <span class="text-xs text-gray-500">${f.managerName}</span></div>`;
                        }
                    });
                }
            });
            
            // ä¿®æ­£é‚è¼¯ï¼šæœ‰è­¦ç¤ºæ‰é¡¯ç¤ºç´…è‰²çœ‹æ¿ï¼Œå¦å‰‡å®Œå…¨éš±è—
            if (alertCount > 0) {
                alertSection.classList.remove('hidden');
                document.getElementById('ownerHealthTitle').innerText = "è­¦ç¤ºï¼šåŠ å…¥æ»¿4å€‹æœˆä»æœªé•·é«˜"; // å‹•æ…‹è¨­å®šæ¨™é¡Œ
                alertList.classList.remove('hidden');
            } else {
                alertSection.classList.add('hidden');
            }

            document.getElementById('ownerTotalFamilies').innerText = stats.total;
            document.getElementById('ownerRiskCount').innerText = stats.risk;
            document.getElementById('ownerBirthdayCount').innerText = stats.bday;
            document.getElementById('ownerBirthdayList').innerText = bdayNames.length ? bdayNames.join(', ') : 'ç„¡';
            filterOwnerTable('all', null, families); 
        }

        let managerChartInstance = null, nationChartInstance = null;
        function updateCharts(families) {
            const managerData = {}; families.forEach(f => { const mName = f.managerName || 'æœªçŸ¥'; if(!managerData[mName]) managerData[mName] = { totalH: 0, count: 0 }; if(f.kids) f.kids.forEach(k => { const latest = getLatestLog(k); const h = latest ? latest.height : k.initialHeight; managerData[mName].totalH += Number(h); managerData[mName].count++; }); }); const mLabels = Object.keys(managerData); const mValues = mLabels.map(name => (managerData[name].totalH / managerData[name].count).toFixed(1));
            const nationData = {}; families.forEach(f => { const nat = f.nationality || 'æœªçŸ¥'; if(!nationData[nat]) nationData[nat] = { totalGrow: 0, count: 0 }; if(f.kids) f.kids.forEach(k => { const latest = getLatestLog(k); const currentH = latest ? latest.height : k.initialHeight; const grow = Number(currentH) - Number(k.initialHeight || 0); nationData[nat].totalGrow += grow; nationData[nat].count++; }); }); const nLabels = Object.keys(nationData); const nValues = nLabels.map(nat => (nationData[nat].totalGrow / nationData[nat].count).toFixed(1));
            if(managerChartInstance) managerChartInstance.destroy(); const ctxM = document.getElementById('managerChart').getContext('2d'); managerChartInstance = new Chart(ctxM, { type: 'bar', data: { labels: mLabels, datasets: [{ label: 'å¹³å‡èº«é«˜ (cm)', data: mValues, backgroundColor: 'rgba(255, 152, 0, 0.6)', borderColor: 'rgba(255, 152, 0, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } } });
            if(nationChartInstance) nationChartInstance.destroy(); const ctxN = document.getElementById('nationChart').getContext('2d'); nationChartInstance = new Chart(ctxN, { type: 'bar', data: { labels: nLabels, datasets: [{ label: 'å¹³å‡ç”Ÿé•·å¹…åº¦ (cm)', data: nValues, backgroundColor: 'rgba(160, 82, 45, 0.6)', borderColor: 'rgba(160, 82, 45, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
        }
        function openTransferModal(sid, sname) { transferSourceId = sid; document.getElementById('transferModalTitle').innerText = `ç§»äº¤ ${sname} çš„å®¶åº­`; const sel = document.getElementById('targetManagerSelect'); sel.innerHTML = '<option>è«‹é¸æ“‡</option>'; allStaffCache.filter(s=>s.id!==sid).forEach(s => sel.innerHTML += `<option value="${s.id}">${s.name}</option>`); document.getElementById('transferModal').classList.remove('hidden'); }
        async function confirmTransfer() { const tid = document.getElementById('targetManagerSelect').value; if(!tid) return; const tName = document.getElementById('targetManagerSelect').options[document.getElementById('targetManagerSelect').selectedIndex].text; const batch = db.batch(); const snap = await db.collection('families').where('managerId','==',transferSourceId).get(); snap.forEach(doc => batch.update(doc.ref, {managerId: tid, managerName: tName})); await batch.commit(); alert('ç§»äº¤æˆåŠŸ'); document.getElementById('transferModal').classList.add('hidden'); }
        function filterOwnerTable(type, val, families) { const tbody = document.getElementById('ownerFamilyTable'); tbody.innerHTML = ''; let filtered = families || window.currentFamilies || []; if (type === 'risk') filtered = filtered.filter(f => f.riskLevel === 'red'); if (type === 'nation') filtered = filtered.filter(f => f.nationality === val); if (type === 'search') { const term = document.getElementById('familySearch').value.toLowerCase(); filtered = filtered.filter(f => { const parent = f.parentName.toLowerCase(); const nation = f.nationality.toLowerCase(); const kidNames = f.kids ? f.kids.map(k => k.name.toLowerCase()).join(' ') : ''; return parent.includes(term) || nation.includes(term) || kidNames.includes(term); }); } filtered.forEach(f => { const k = f.kids && f.kids.length > 0 ? f.kids[0] : { name: '-', dob: '-' }; const latest = getLatestLog(k); const currentH = latest ? latest.height : k.initialHeight || 0; const grow = (Number(currentH) - Number(k.initialHeight || 0)).toFixed(1); const directorName = (f.managerId && managerDirectorMap[f.managerId]) ? managerDirectorMap[f.managerId] : '-'; tbody.innerHTML += `<tr class="hover:bg-gray-50 transition border-b border-gray-100"><td class="p-3 font-bold text-gray-600">${f.nationality}</td><td class="p-3 font-bold text-gray-800">${f.parentName}</td><td class="p-3"><div class="font-bold text-gray-800">${k.name}</div><div class="text-xs text-gray-400">${k.dob}</div></td><td class="p-3"><div>${currentH} cm</div><div class="text-xs text-riskGreen font-bold">+${grow} cm</div></td><td class="p-3 text-sm text-gray-600">${f.managerName}</td><td class="p-3 text-sm text-primary font-bold">${directorName}</td><td class="p-3 text-center"><span class="risk-dot ${getRiskDotClass(f.riskLevel)}"></span></td><td class="p-3 text-center"><button onclick="openFamilyModal('${f.id}')" class="bg-secondary text-black px-3 py-1 rounded text-xs hover:opacity-80 transition font-bold">æŸ¥çœ‹</button></td></tr>`; }); }
        
        // â˜… Update Director Dashboard to use health board logic with merged data â˜…
        async function initDirectorDashboard() {
             const myContainer = document.getElementById('directorMyFamilyList');
             const teamDiv = document.getElementById('directorTeamList'); 
             const riskDiv = document.getElementById('directorRiskList'); 
             const familyTableBody = document.getElementById('directorFamilyTable');

             // æš«å­˜é™£åˆ—ï¼Œç”¨æ–¼åˆä½µå€‹äººèˆ‡åœ˜éšŠçš„åœæ»¯åå–®
             let myStagnantCases = [];
             let teamStagnantCases = [];

             // æ›´æ–°è­¦ç¤ºçœ‹æ¿çš„å…§éƒ¨å‡½æ•¸
             function renderDirectorAlerts() {
                const board = document.getElementById('directorHealthBoard');
                const list = document.getElementById('directorStagnantList');
                // åˆä½µå…©å€‹é™£åˆ—
                const allCases = [...myStagnantCases, ...teamStagnantCases];

                list.innerHTML = '';
                if (allCases.length > 0) {
                    board.classList.remove('hidden');
                    document.getElementById('directorHealthTitle').innerText = "è­¦ç¤ºï¼šåŠ å…¥æ»¿4å€‹æœˆä»æœªé•·é«˜";
                    
                    allCases.forEach(item => {
                         list.innerHTML += `<div class="bg-white p-2 rounded shadow-sm border border-red-200 flex justify-between items-center">
                            <span class="font-bold text-gray-800">${item.kidName}</span> 
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded border border-gray-200">${item.managerName}</span>
                         </div>`;
                    });
                } else {
                    board.classList.add('hidden');
                }
             }

             // 1. ç›£è½ã€å€‹äººç®¡ç†ã€‘çš„å®¶åº­
             db.collection('families').where('managerId', '==', currentUser.uid).onSnapshot(snap => {
                myContainer.innerHTML = snap.empty ? '<div class="col-span-3 text-center bg-white p-6 rounded border text-gray-500">æ‚¨ç›®å‰æ²’æœ‰è¦ªè‡ªç®¡ç†çš„å®¶åº­</div>' : '';
                myStagnantCases = []; // æ¸…ç©ºé‡ç®—

                snap.forEach(doc => {
                    const d = doc.data();
                    
                    // æª¢æŸ¥ç”Ÿé•·åœæ»¯ (å€‹äºº)
                    if (d.kids) d.kids.forEach(kid => {
                        if (checkGrowthStagnation(kid, d.joinDate)) {
                            myStagnantCases.push({ kidName: kid.name, managerName: 'æˆ‘ (ç­ä¸»ä»»)' });
                        }
                    });

                    // æ¸²æŸ“å¡ç‰‡ (çœç•¥ç´°ç¯€ï¼Œèˆ‡ä¹‹å‰ç›¸åŒ)
                    const kidNames = d.kids ? d.kids.map(k => k.name).join(', ') : '';
                    const k1 = d.kids && d.kids.length > 0 ? d.kids[0] : null;
                    let lastInfo = 'ç„¡ç´€éŒ„';
                    let growthStr = '';
                    if (k1) {
                        const latest = getLatestLog(k1);
                        const lastH = latest ? latest.height : k1.initialHeight;
                        const lastDate = latest ? (latest.date || latest.month) : 'åˆå§‹';
                        lastInfo = `æœ€æ–°: ${lastDate} / èº«é«˜ ${lastH}cm`;
                        const growth = (Number(lastH) - Number(k1.initialHeight)).toFixed(1);
                        growthStr = `<span class="text-green-600 font-bold">(+${growth})</span>`;
                    }
                    const riskClass = getRiskClass(d.riskLevel);
                    const riskLabel = getRiskLabel(d.riskLevel);
                    const borderClass = d.riskLevel === 'red' ? 'border-riskRed' : (d.riskLevel === 'yellow' ? 'border-riskYellow' : 'border-riskGreen');

                    myContainer.innerHTML += `
                        <div class="bg-white p-4 rounded shadow border-l-4 ${borderClass} hover:shadow-lg transition flex flex-col md:flex-row items-center justify-between gap-4 w-full relative">
                            <div class="flex-grow w-full md:w-auto cursor-pointer" onclick="openFamilyModal('${doc.id}', 'records')">
                                <div class="flex items-center flex-wrap gap-2 mb-1">
                                    <h3 class="font-bold text-lg text-gray-800">${d.parentName}</h3>
                                    <span class="text-xs px-2 py-1 bg-gray-100 rounded text-gray-600">${d.nationality}</span>
                                    <span class="text-xs px-2 py-1 rounded font-bold ${riskClass}">${riskLabel}</span>
                                </div>
                                <div class="text-sm text-gray-600 flex flex-wrap gap-4 items-center">
                                    <span><i class="fa-solid fa-child text-accent"></i> ${kidNames}</span>
                                    <span class="text-gray-500">${lastInfo} ${growthStr}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 w-full md:w-auto justify-end z-10">
                                <button onclick="event.stopPropagation(); openFamilyModal('${doc.id}', 'basic');" class="bg-white border border-secondary text-black px-4 py-2 rounded hover:bg-secondary hover:text-white transition text-sm font-bold whitespace-nowrap flex items-center gap-1">
                                    <i class="fa-solid fa-pen-to-square"></i> ç·¨è¼¯è³‡æ–™
                                </button>
                                <button onclick="event.stopPropagation(); deleteFamily('${doc.id}', '${d.parentName}')" class="text-red-400 hover:text-red-600 px-2 transition" title="åˆªé™¤å®¶åº­">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>`;
                });
                renderDirectorAlerts(); // æ¯æ¬¡æ•¸æ“šè®Šå‹•éƒ½é‡æ–°æ¸²æŸ“è­¦ç¤º
            });

             // 2. ç›£è½ã€åœ˜éšŠç£å°ã€‘çš„å®¶åº­
             log('æ­£åœ¨è¼‰å…¥åœ˜éšŠåå–®...', 'info');
             const teamSnap = await db.collection('users').where('directorId', '==', currentUser.uid).get();
             const teamIds = teamSnap.docs.map(d => d.id);
             log(`æ‰¾åˆ° ${teamIds.length} ä½ä¸‹å±¬ç®¡ç†å¸«`, 'info');
             
             // å¦‚æœæ²’æœ‰ä¸‹å±¬ï¼Œçµ¦ä¸€å€‹ dummy ID é¿å…å ±éŒ¯
             const queryIds = teamIds.length ? teamIds : ['dummy_query_id'];

             db.collection('families').where('managerId', 'in', queryIds).onSnapshot(fSnap => {
                teamDiv.innerHTML = ''; riskDiv.innerHTML = ''; familyTableBody.innerHTML = '';
                teamStagnantCases = []; // æ¸…ç©ºé‡ç®—
                let managerStats = {};
                
                if(fSnap.empty) log('ä¸‹å±¬ç›®å‰æ²’æœ‰ç®¡ç†ä»»ä½•å®¶åº­', 'warn');

                fSnap.forEach(doc => {
                    const d = doc.data();
                    
                    // æª¢æŸ¥ç”Ÿé•·åœæ»¯ (åœ˜éšŠ)
                    if(d.kids) d.kids.forEach(kid => {
                        if(checkGrowthStagnation(kid, d.joinDate)) {
                             teamStagnantCases.push({ kidName: kid.name, managerName: d.managerName || 'æœªçŸ¥' });
                        }
                    });
                    
                    // (æ¸²æŸ“åœ˜éšŠæ•¸æ“šèˆ‡è¡¨æ ¼ï¼Œèˆ‡ä¹‹å‰é‚è¼¯ç›¸åŒ)
                    const k = d.kids && d.kids.length > 0 ? d.kids[0] : { name: '-', dob: '-', initialHeight: 0 };
                    const latest = getLatestLog(k);
                    const lastH = latest ? latest.height : k.initialHeight;
                    const growth = (Number(lastH) - Number(k.initialHeight)).toFixed(1);
                    const mId = d.managerId;
                    const mName = d.managerName || 'æœªåˆ†é…';

                    if (!managerStats[mId]) managerStats[mId] = { name: mName, total: 0, stable: 0 };
                    managerStats[mId].total++;
                    if (d.riskLevel === 'green') managerStats[mId].stable++;

                    if(d.riskLevel === 'red' || d.riskLevel === 'yellow') { 
                        riskDiv.innerHTML += `<div class="p-3 border-l-4 ${d.riskLevel==='red'?'border-riskRed bg-red-50':'border-riskYellow bg-yellow-50'} rounded shadow-sm flex justify-between items-center mb-2"><div><p class="font-bold text-gray-800">${d.parentName}</p><p class="text-xs text-gray-500">è² è²¬äºº: ${d.managerName}</p></div><div class="text-right"><span class="text-xs font-bold px-2 py-1 bg-white rounded shadow-sm border border-gray-200">${d.riskLevel==='red'?'é«˜é¢¨éšª':'è§€å¯Ÿ'}</span></div></div>`; 
                    }
                    
                    familyTableBody.innerHTML += `<tr class="hover:bg-gray-50 transition border-b border-gray-100"><td class="p-3 font-bold text-gray-600">${d.nationality}</td><td class="p-3"><div class="font-bold text-gray-800">${k.name}</div><div class="text-xs text-gray-400">${k.dob}</div></td><td class="p-3"><div>${lastH} cm</div><div class="text-xs text-green-600 font-bold">+${growth} cm</div></td><td class="p-3 text-sm text-gray-600">${d.managerName}</td><td class="p-3 text-center"><span class="risk-dot ${getRiskDotClass(d.riskLevel)}"></span></td><td class="p-3 text-center"><button onclick="openFamilyModal('${doc.id}')" class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs hover:bg-gray-300 transition font-bold">æŸ¥çœ‹è©³æƒ…</button></td></tr>`;
                });

                // æ›´æ–°çœ‹æ¿
                renderDirectorAlerts();

                Object.values(managerStats).forEach(stat => {
                    const rate = stat.total ? Math.round((stat.stable / stat.total) * 100) : 0;
                    teamDiv.innerHTML += `<div class="bg-white p-4 rounded border border-orange-100 flex justify-between items-center shadow-sm mb-2"><div><p class="font-bold text-lg text-gray-800">${stat.name}</p><p class="text-xs text-gray-500">ç®¡ç† ${stat.total} æˆ¶</p></div><div class="text-right"><p class="text-2xl font-bold ${rate < 60 ? 'text-riskRed' : 'text-riskGreen'}">${rate}%</p><p class="text-xs text-gray-400">ç©©å®šç‡</p></div></div>`;
                });
             });
        }
        
        function getRiskClass(level) { if(level === 'red') return 'bg-red-100 text-riskRed'; if(level === 'yellow') return 'bg-yellow-100 text-riskYellow'; return 'bg-green-100 text-riskGreen'; }
        function getRiskLabel(level) { if(level === 'red') return 'é«˜é¢¨éšª'; if(level === 'yellow') return 'è§€å¯Ÿä¸­'; return 'ç©©å®š'; }
        function getRiskDotClass(level) { if(level === 'red') return 'bg-riskRed'; if(level === 'yellow') return 'bg-riskYellow'; return 'bg-riskGreen'; }
    </script>
</body>
</html>