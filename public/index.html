<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…’ç«¥ç”Ÿé•·ç®¡ç†ç³»çµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#FFF9C4', // éµé»ƒè‰²èƒŒæ™¯ (ä¸»è¦)
                        card: '#FFFFF0', // è±¡ç‰™ç™½å¡ç‰‡
                        primary: '#FF9800', // æº«æš–æ©˜ (æŒ‰éˆ•/é‡é»)
                        secondary: '#C36E1B', // æº«æš–ç´…æ£•è‰² (å°èˆª/ä¸»è¦æ–‡å­—)
                        accent: '#FFB74D', // æ·ºæ©˜
                        riskRed: '#D32F2F', // é¢¨éšªç´…
                        riskYellow: '#FBC02D',
                        riskGreen: '#388E3C',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #FFF9C4; color: #C36E1B; }
        .hidden { display: none !important; }
        .risk-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .tab-btn { border-bottom: 3px solid transparent; opacity: 0.8; }
        .tab-btn.active { border-bottom: 3px solid #FF9800; opacity: 1; font-weight: bold; }
        ::selection { background: #FFCC80; color: #C36E1B; }
        .loading-overlay { background-color: rgba(255, 255, 255, 0.7); z-index: 100; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- å°èˆªåˆ— -->
    <nav class="bg-secondary text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-sun text-yellow-300 text-xl animate-pulse"></i>
            <h1 class="text-xl font-bold tracking-wide">å…’ç«¥ç”Ÿé•·ç®¡ç†ç³»çµ±</h1>
        </div>
        <div id="navUser" class="hidden flex items-center gap-3">
            <div class="text-right leading-tight">
                <span id="userRoleDisplay" class="block text-xs bg-primary px-1 rounded inline-block mb-1"></span>
                <span id="userNameDisplay" class="text-sm font-bold"></span>
            </div>
            <button onclick="logout()" class="bg-white text-secondary px-3 py-2 rounded hover:bg-gray-200 transition text-sm font-bold">
                <i class="fa-solid fa-sign-out-alt"></i> ç™»å‡º
            </button>
        </div>
    </nav>
    
    <!-- å…¨åŸŸéŒ¯èª¤/é€£ç·šç‹€æ…‹æç¤º -->
    <div id="connectionStatus" class="bg-red-100 text-red-700 p-3 text-center hidden font-bold">
        <i class="fa-solid fa-exclamation-triangle mr-2"></i> æ­£åœ¨æª¢æŸ¥é€£ç·šè¨­å®š...
    </div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="flex-grow p-4 md:p-6 max-w-7xl mx-auto w-full">
        
        <!-- 1. ç™»å…¥/è¨»å†Šå€å¡Š (Auth Section) -->
        <div id="authSection" class="max-w-md mx-auto bg-card p-0 rounded-xl shadow-xl mt-10 overflow-hidden border border-orange-200">
            <!-- é ç±¤ Header -->
            <div class="flex bg-orange-100">
                <button onclick="switchAuthTab('login')" id="tab-login" class="tab-btn active flex-1 py-4 text-center text-secondary transition">ç™»å…¥ç³»çµ±</button>
                <button onclick="switchAuthTab('register')" id="tab-register" class="tab-btn flex-1 py-4 text-center text-secondary transition">è¨»å†Šå¸³è™Ÿ</button>
            </div>

            <div class="p-8">
                <!-- ç™»å…¥è¡¨å–® -->
                <form id="loginForm" onsubmit="handleAuth(event, 'login')" class="space-y-6">
                    <div class="text-center mb-6">
                        <i class="fa-solid fa-circle-user text-6xl text-orange-200"></i>
                        <h2 class="text-xl font-bold text-secondary mt-2">æ­¡è¿å›ä¾†</h2>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-secondary"><i class="fa-solid fa-id-card"></i> å¸³è™Ÿ</label>
                        <input type="text" id="loginId" placeholder="è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿ" class="w-full p-3 border border-orange-200 rounded-lg focus:outline-none focus:border-primary bg-white text-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-secondary"><i class="fa-solid fa-lock"></i> å¯†ç¢¼</label>
                        <input type="password" id="loginPwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full p-3 border border-orange-200 rounded-lg focus:outline-none focus:border-primary bg-white text-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-orange-600 transition font-bold shadow-md text-lg">
                        ç™»å…¥
                    </button>
                </form>

                <!-- è¨»å†Šè¡¨å–® (é è¨­éš±è—) -->
                <form id="registerForm" onsubmit="handleAuth(event, 'register')" class="space-y-4 hidden">
                    <div class="bg-yellow-50 p-4 rounded text-sm text-secondary mb-4 border-l-4 border-primary">
                        <p class="font-bold">æ–°é€²ç®¡ç†å¸«è¨­å®š</p>
                        <p>è«‹è‡ªè¡Œè¨­å®šä¸€çµ„å¥½è¨˜çš„å¸³è™Ÿèˆ‡å¯†ç¢¼ã€‚</p>
                        <p class="text-xs text-gray-500 mt-1">* ç³»çµ±ç¬¬ä¸€ä½è¨»å†Šè€…å°‡è‡ªå‹•æˆç‚ºè€é—†ã€‚</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-1 text-secondary">å§“å</label>
                        <input type="text" id="regName" placeholder="æ‚¨çš„çœŸå¯¦å§“å" class="w-full p-3 border border-orange-200 rounded focus:outline-none focus:border-primary bg-white" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1 text-secondary">è‡ªè¨‚å¸³è™Ÿ</label>
                        <input type="text" id="regId" placeholder="ä¾‹å¦‚: manager01" class="w-full p-3 border border-orange-200 rounded focus:outline-none focus:border-primary bg-white" required>
                        <p class="text-xs text-gray-400 mt-1">è«‹ä½¿ç”¨è‹±æ•¸å­—çµ„åˆ</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1 text-secondary">è‡ªè¨‚å¯†ç¢¼</label>
                        <input type="password" id="regPwd" placeholder="è‡³å°‘6ä½æ•¸" class="w-full p-3 border border-orange-200 rounded focus:outline-none focus:border-primary bg-white" required>
                    </div>
                    <button type="submit" class="w-full bg-secondary text-white py-3 rounded hover:bg-brown-700 transition font-bold shadow-md">
                        å»ºç«‹å¸³è™Ÿ
                    </button>
                </form>
            </div>
        </div>

        <!-- 2. è€é—†å„€è¡¨æ¿ (Owner) -->
        <div id="ownerDashboard" class="hidden space-y-6 animate-fade-in">
            <!-- æ•¸æ“šå¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-card p-5 rounded-lg shadow border-l-4 border-secondary">
                    <h3 class="text-gray-500 text-sm font-bold">ç¸½å®¶åº­æ•¸</h3>
                    <p class="text-4xl font-bold text-secondary mt-2" id="ownerTotalFamilies">0</p>
                </div>
                <div class="bg-card p-5 rounded-lg shadow border-l-4 border-riskRed">
                    <h3 class="text-gray-500 text-sm font-bold">é«˜é¢¨éšªå®¶åº­</h3>
                    <p class="text-4xl font-bold text-riskRed mt-2" id="ownerRiskCount">0</p>
                </div>
                <div class="bg-card p-5 rounded-lg shadow border-l-4 border-riskGreen">
                    <h3 class="text-gray-500 text-sm font-bold">å¹³å‡é•·é«˜</h3>
                    <p class="text-4xl font-bold text-riskGreen mt-2" id="ownerAvgGrowth">0 <span class="text-sm text-gray-400">cm</span></p>
                </div>
                 <div class="bg-card p-5 rounded-lg shadow border-l-4 border-primary">
                    <h3 class="text-gray-500 text-sm font-bold">ç•¶æœˆå£½æ˜Ÿ</h3>
                    <p class="text-4xl font-bold text-primary mt-2" id="ownerBirthdayCount">0</p>
                </div>
            </div>

            <!-- äººå“¡ç®¡ç†å€ -->
            <div class="bg-card p-6 rounded-lg shadow">
                <h3 class="text-xl font-bold mb-4 text-secondary flex items-center gap-2">
                    <i class="fa-solid fa-users-gear"></i> äººå“¡æ¬Šé™ç®¡ç†
                </h3>
                <div id="staffList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- å…¨æ©Ÿæ§‹ç¸½è¦½ -->
            <div class="bg-card p-6 rounded-lg shadow">
                <h3 class="text-xl font-bold mb-4 text-secondary flex items-center gap-2">
                    <i class="fa-solid fa-chart-line"></i> å…¨æ©Ÿæ§‹å®¶åº­æˆé•·è¶¨å‹¢
                </h3>
                <!-- ç¯©é¸å™¨ -->
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button onclick="filterOwnerTable('all')" class="bg-secondary text-white px-3 py-1 rounded text-sm whitespace-nowrap hover:bg-opacity-90 transition">å…¨éƒ¨</button>
                    <button onclick="filterOwnerTable('risk')" class="bg-riskRed text-white px-3 py-1 rounded text-sm whitespace-nowrap hover:bg-opacity-90 transition">é«˜é¢¨éšª</button>
                    <!-- åœ‹ç±æŒ‰éˆ•æœƒå‹•æ…‹å¢åŠ åœ¨é€™è£¡ -->
                    <div id="nationFilters" class="flex gap-2"></div>
                </div>

                <div class="overflow-x-auto rounded-lg border border-orange-100">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-orange-100 text-secondary text-sm">
                                <th class="p-3">åœ‹ç±</th>
                                <th class="p-3">å­©ç«¥/ç”Ÿæ—¥</th>
                                <th class="p-3">ç”Ÿé•·æ•¸æ“š (ç›®å‰/é•·é«˜)</th>
                                <th class="p-3">è² è²¬äººå“¡</th>
                                <th class="p-3 text-center">é¢¨éšª</th>
                            </tr>
                        </thead>
                        <tbody id="ownerFamilyTable" class="text-sm bg-white divide-y divide-orange-50">
                            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. ç­ä¸»ä»»å„€è¡¨æ¿ (Director) -->
        <div id="directorDashboard" class="hidden space-y-6">
             <div class="bg-yellow-100 border-l-4 border-primary text-yellow-800 p-4 rounded shadow-sm" role="alert">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-user-tie text-xl"></i>
                    <div>
                        <p class="font-bold">ç­ä¸»ä»»ç£å°æ¨¡å¼</p>
                        <p class="text-sm">åƒ…ä¾›æª¢è¦–æ——ä¸‹ç®¡ç†å¸«ç¸¾æ•ˆèˆ‡å®¶åº­ç‹€æ³ï¼Œä¸å¯ç·¨è¼¯ã€‚</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- å·¦å´ï¼šç®¡ç†å¸«ç¸¾æ•ˆ -->
                <div class="bg-card p-6 rounded-lg shadow h-fit">
                    <h3 class="text-xl font-bold mb-4 text-secondary border-b pb-2 border-orange-100">æ——ä¸‹ç®¡ç†å¸«è¡¨ç¾</h3>
                    <div id="directorTeamList" class="space-y-3">
                        <!-- JS -->
                    </div>
                </div>

                <!-- å³å´ï¼šé‡é»é—œæ³¨å®¶åº­ -->
                <div class="bg-card p-6 rounded-lg shadow">
                    <h3 class="text-xl font-bold mb-4 text-secondary border-b pb-2 border-orange-100">éœ€é—œæ³¨å®¶åº­ (ç´…/é»ƒç‡ˆ)</h3>
                    <div id="directorRiskList" class="space-y-3 max-h-[500px] overflow-y-auto">
                        <!-- JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. ç®¡ç†å¸«å„€è¡¨æ¿ (Manager) -->
        <div id="managerDashboard" class="hidden space-y-6">
            <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm">
                <div>
                    <h2 class="text-2xl font-bold text-secondary">æˆ‘çš„å®¶åº­ç®¡ç†</h2>
                    <p class="text-gray-500 text-sm">ç®¡ç†èˆ‡ç´€éŒ„å­©ç«¥ç”Ÿé•·æ›²ç·š</p>
                </div>
                <button onclick="openFamilyModal()" class="bg-primary text-white px-5 py-2 rounded-full shadow hover:bg-orange-600 font-bold transition transform hover:scale-105 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> æ–°å¢å®¶åº­
                </button>
            </div>

            <div id="managerFamilyList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- å®¶åº­å¡ç‰‡å€ JS -->
            </div>
        </div>

    </main>

    <!-- å½ˆå‡ºè¦–çª—ï¼šæ–°å¢/ç·¨è¼¯å®¶åº­ (Modal) -->
    <div id="familyModal" class="hidden fixed inset-0 bg-secondary bg-opacity-70 flex justify-center items-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-card rounded-xl w-full max-w-3xl shadow-2xl relative max-h-[90vh] overflow-y-auto border-t-8 border-primary">
            <!-- é—œé–‰æŒ‰éˆ• -->
            <button onclick="closeFamilyModal()" class="absolute top-4 right-4 text-gray-400 hover:text-riskRed w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
            
            <div class="p-6 md:p-8">
                <h3 id="modalTitle" class="text-2xl font-bold mb-6 text-secondary border-b pb-2">æ–°å¢å®¶åº­è³‡æ–™</h3>
                
                <form id="familyForm" onsubmit="saveFamily(event)" class="space-y-6">
                    <input type="hidden" id="familyId">
                    
                    <!-- å®¶é•·åŸºæœ¬è³‡æ–™ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-white p-4 rounded border border-orange-100">
                        <div>
                            <label class="block text-xs font-bold text-primary uppercase mb-1">å®¶é•·å§“å</label>
                            <input type="text" id="parentName" class="w-full border-b-2 border-orange-200 focus:border-primary outline-none py-2 bg-transparent transition" placeholder="è¼¸å…¥å§“å" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-primary uppercase mb-1">åœ‹ç±</label>
                            <input type="text" id="nationality" class="w-full border-b-2 border-orange-200 focus:border-primary outline-none py-2 bg-transparent transition" placeholder="ä¾‹å¦‚: è¶Šå—, å°å°¼, å°ç£" required>
                        </div>
                    </div>

                    <!-- é¢¨éšªèˆ‡ç‹€æ…‹ -->
                    <div class="bg-white p-4 rounded border border-orange-100">
                        <label class="block text-xs font-bold text-primary uppercase mb-3">ç®¡ç†é¢¨éšªç‡ˆè™Ÿ</label>
                        <div class="flex gap-4">
                            <label class="cursor-pointer border p-2 rounded hover:bg-green-50 w-full text-center has-[:checked]:border-riskGreen has-[:checked]:bg-green-100 transition">
                                <input type="radio" name="risk" value="green" class="hidden" checked> 
                                <span class="text-riskGreen font-bold"><i class="fa-solid fa-circle"></i> ç©©å®š</span>
                            </label>
                            <label class="cursor-pointer border p-2 rounded hover:bg-yellow-50 w-full text-center has-[:checked]:border-riskYellow has-[:checked]:bg-yellow-100 transition">
                                <input type="radio" name="risk" value="yellow" class="hidden"> 
                                <span class="text-riskYellow font-bold"><i class="fa-solid fa-circle"></i> è§€å¯Ÿ</span>
                            </label>
                            <label class="cursor-pointer border p-2 rounded hover:bg-red-50 w-full text-center has-[:checked]:border-riskRed has-[:checked]:bg-red-100 transition">
                                <input type="radio" name="risk" value="red" class="hidden"> 
                                <span class="text-riskRed font-bold"><i class="fa-solid fa-circle"></i> é«˜é¢¨éšª</span>
                            </label>
                        </div>

                        <div class="mt-4">
                            <label class="block text-xs font-bold text-primary uppercase mb-1">ç®¡ç†ç‹€æ³å›å ±</label>
                            <textarea id="statusReport" class="w-full border border-orange-200 rounded p-2 focus:border-primary h-20 bg-gray-50 focus:bg-white transition" placeholder="è«‹å¡«å¯«æœ¬æœˆè¨ªè¦–æˆ–é›»è¨ªç‹€æ³..."></textarea>
                        </div>
                    </div>

                    <!-- å­©ç«¥è³‡æ–™ (æ”¯æ´å¤šä½) -->
                    <div class="bg-white p-4 rounded border border-orange-100 relative">
                        <h4 class="font-bold text-secondary mb-3 flex items-center gap-2"><i class="fa-solid fa-baby"></i> å­©ç«¥è³‡æ–™</h4>
                        
                        <!-- ç°¡åŒ–ç‰ˆï¼šç›®å‰å…ˆåšä¸€ä½å­©ç«¥ï¼Œè‹¥éœ€å¤šä½å¯æ“´å…… -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-3">
                                <label class="block text-xs text-gray-500">å­©ç«¥å§“å</label>
                                <input type="text" id="kidName" class="w-full border p-2 rounded bg-gray-50" required>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500">ç”Ÿæ—¥</label>
                                <input type="date" id="kidDob" class="w-full border p-2 rounded bg-gray-50" required>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500">éª¨é½¡ (æ­²)</label>
                                <input type="number" step="0.1" id="kidBoneAge" class="w-full border p-2 rounded bg-gray-50" placeholder="æœªæ¸¬å…å¡«">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-500">åˆå§‹èº«é«˜</label>
                                    <input type="number" step="0.1" id="initHeight" class="w-full border p-2 rounded bg-gray-50" required>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500">åˆå§‹é«”é‡</label>
                                    <input type="number" step="0.1" id="initWeight" class="w-full border p-2 rounded bg-gray-50" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æœ¬æœˆç´€éŒ„è¼¸å…¥ -->
                    <div class="bg-primary bg-opacity-10 p-4 rounded border border-primary border-dashed">
                        <h5 class="text-sm font-bold text-primary mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-pen-to-square"></i> æ–°å¢æ¸¬é‡ç´€éŒ„ (é¸å¡«)
                        </h5>
                        <div class="flex flex-wrap gap-2 items-end">
                            <div class="flex-1 min-w-[120px]">
                                <label class="text-xs text-gray-500">æœˆä»½</label>
                                <input type="month" id="logMonth" class="w-full border p-2 rounded text-sm">
                            </div>
                            <div class="flex-1 min-w-[80px]">
                                <label class="text-xs text-gray-500">èº«é«˜ (cm)</label>
                                <input type="number" id="logHeight" step="0.1" class="w-full border p-2 rounded text-sm">
                            </div>
                            <div class="flex-1 min-w-[80px]">
                                <label class="text-xs text-gray-500">é«”é‡ (kg)</label>
                                <input type="number" id="logWeight" step="0.1" class="w-full border p-2 rounded text-sm">
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-secondary text-white py-3 rounded-lg hover:bg-brown-600 transition font-bold text-lg shadow-lg">
                        <i class="fa-solid fa-save"></i> å„²å­˜è³‡æ–™
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Modular Style via Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // ==========================================
        // 1. Firebase è¨­å®š (è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Config)
        // ==========================================
        // ğŸš¨ é‡è¦ï¼šè«‹å°‡æ­¤è™•çš„è¨­å®šæ›¿æ›ç‚ºæ‚¨ j-growth-app-new å°ˆæ¡ˆçš„å¯¦éš› Config è³‡è¨Š
    const firebaseConfig = {
    apiKey: "AIzaSyBS8RCrZArtOLddiTSK8zt5VD2ODuYxLoA", 
    authDomain: "j-growth-app-new.firebaseapp.com",
    projectId: "j-growth-app-new",
    storageBucket: "j-growth-app-new.firebasestorage.app",
    messagingSenderId: "573660567724",
    appId: "1:573660567724:web:f8464351a96e276112a709"
};
        
        // å…¨åŸŸç‹€æ…‹ DOM
        const statusDiv = document.getElementById('connectionStatus');

        // åˆå§‹åŒ– Firebase (ä½¿ç”¨ try/catch æª¢æŸ¥ config æ˜¯å¦æ­£ç¢º)
        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase App åˆå§‹åŒ–æˆåŠŸã€‚");
            statusDiv.classList.add('hidden'); // å¦‚æœæˆåŠŸï¼Œéš±è—éŒ¯èª¤æç¤º
        } catch (error) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•— (Config éŒ¯èª¤æˆ–ç¶²è·¯å•é¡Œ):", error);
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = `<i class="fa-solid fa-exclamation-triangle mr-2"></i> <strong>åš´é‡éŒ¯èª¤:</strong> Firebase è¨­å®šæª”éŒ¯èª¤æˆ–ç¶²è·¯é€£ç·šå¤±æ•—ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Console è¼¸å‡ºèˆ‡ Configã€‚`;
            throw new Error("åˆå§‹åŒ–å¤±æ•—");
        }


        let currentUser = null;
        let userData = null;
        const FAKE_DOMAIN = "@growth.system"; 

        // ==========================================
        // 2. Auth & Login é‚è¼¯ (å¸³è™Ÿåˆ¶)
        // ==========================================
        
        function switchAuthTab(tab) {
            document.getElementById('tab-login').classList.remove('active');
            document.getElementById('tab-register').classList.remove('active');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');

            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`${tab}Form`).classList.remove('hidden');
        }

        async function handleAuth(e, type) {
            e.preventDefault();
            
            try {
                if (type === 'login') {
                    const id = document.getElementById('loginId').value.trim();
                    const pwd = document.getElementById('loginPwd').value;
                    const email = id + FAKE_DOMAIN; 
                    
                    await auth.signInWithEmailAndPassword(email, pwd);

                } else if (type === 'register') {
                    const name = document.getElementById('regName').value.trim();
                    const id = document.getElementById('regId').value.trim();
                    const pwd = document.getElementById('regPwd').value;
                    const email = id + FAKE_DOMAIN;

                    const usersSnap = await db.collection('users').get();
                    const isFirstUser = usersSnap.empty;
                    const role = isFirstUser ? 'owner' : 'manager';

                    const userCredential = await auth.createUserWithEmailAndPassword(email, pwd);
                    
                    await db.collection('users').doc(userCredential.user.uid).set({
                        name: name,
                        username: id,
                        role: role,
                        createdAt: new Date(),
                        managerId: null 
                    });

                    alert(`è¨»å†ŠæˆåŠŸï¼èº«åˆ†ï¼š${role === 'owner' ? 'è€é—† (ç³»çµ±ç®¡ç†å“¡)' : 'ç®¡ç†å¸«'}`);
                }
            } catch (error) {
                console.error("Auth éŒ¯èª¤:", error);
                let msg = error.message;
                if(error.code === 'auth/network-request-failed') msg = 'ç¶²è·¯é€£ç·šå¤±æ•—æˆ– Firebase Config è¨­å®šéŒ¯èª¤ã€‚';
                if(error.code === 'auth/email-already-in-use') msg = 'æ­¤å¸³è™Ÿå·²è¢«ä½¿ç”¨ï¼Œè«‹æ›´æ›ä¸€å€‹ã€‚';
                if(error.code === 'auth/weak-password') msg = 'å¯†ç¢¼å¼·åº¦å¤ªå¼± (è‡³å°‘6ä½)ã€‚';
                if(error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') msg = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ã€‚';
                if(error.code === 'auth/operation-not-allowed') msg = 'è¨»å†Šå¤±æ•—ï¼šè«‹å…ˆåˆ° Firebase å¾Œå°é–‹å•Ÿã€Œé›»å­éƒµä»¶/å¯†ç¢¼ã€é©—è­‰åŠŸèƒ½ï¼';
                alert("æ“ä½œå¤±æ•—: " + msg);
            }
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists) {
                        userData = doc.data();
                        currentUser = user;
                        
                        document.getElementById('authSection').classList.add('hidden');
                        document.getElementById('navUser').classList.remove('hidden');
                        document.getElementById('navUser').classList.add('flex');
                        
                        const roleLabels = { 'owner': 'è€é—†', 'director': 'ç­ä¸»ä»»', 'manager': 'ç®¡ç†å¸«' };
                        document.getElementById('userRoleDisplay').innerText = roleLabels[userData.role];
                        document.getElementById('userNameDisplay').innerText = userData.name;

                        renderDashboard();
                    } else {
                        alert("æŸ¥ç„¡ä½¿ç”¨è€…è³‡æ–™ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡");
                        auth.signOut();
                    }
                } catch (error) {
                    console.error("è³‡æ–™è¼‰å…¥å¤±æ•—:", error);
                    alert("è³‡æ–™åº«é€£ç·šæˆ–æ¬Šé™éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Firestore ç‹€æ…‹ã€‚");
                    auth.signOut();
                }

            } else {
                currentUser = null;
                userData = null;
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('navUser').classList.add('hidden');
                document.getElementById('navUser').classList.remove('flex');
                
                ['ownerDashboard', 'directorDashboard', 'managerDashboard'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
            }
        });

        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                auth.signOut();
                location.reload();
            }
        }

        function renderDashboard() {
            document.getElementById('ownerDashboard').classList.add('hidden');
            document.getElementById('directorDashboard').classList.add('hidden');
            document.getElementById('managerDashboard').classList.add('hidden');

            if (userData.role === 'owner') {
                initOwnerDashboard();
                document.getElementById('ownerDashboard').classList.remove('hidden');
            } else if (userData.role === 'director') {
                initDirectorDashboard();
                document.getElementById('directorDashboard').classList.remove('hidden');
            } else {
                initManagerDashboard();
                document.getElementById('managerDashboard').classList.remove('hidden');
            }
        }

        // ==========================================
        // 3. ç®¡ç†å¸«åŠŸèƒ½ (Manager)
        // ==========================================
        async function initManagerDashboard() {
            const container = document.getElementById('managerFamilyList');
            container.innerHTML = '<div class="col-span-3 text-center py-10"><i class="fa-solid fa-spinner fa-spin text-2xl text-primary"></i> è¼‰å…¥è³‡æ–™ä¸­...</div>';

            db.collection('families').where('managerId', '==', currentUser.uid)
                .onSnapshot(snapshot => {
                    container.innerHTML = '';
                    if (snapshot.empty) {
                        container.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-10">å°šç„¡è³‡æ–™ï¼Œè«‹é»æ“Šå³ä¸Šè§’æ–°å¢å®¶åº­ã€‚</div>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const kid = data.kids[0];
                        const lastLog = (kid.logs && kid.logs.length) ? kid.logs[kid.logs.length-1] : { height: kid.initialHeight, weight: kid.initialWeight };
                        const growth = (lastLog.height - kid.initialHeight).toFixed(1);
                        
                        const growthIcon = growth > 0 ? '<i class="fa-solid fa-arrow-trend-up text-riskGreen"></i>' : '<i class="fa-solid fa-minus text-gray-400"></i>';

                        const html = `
                            <div class="bg-card rounded-lg shadow-md hover:shadow-xl transition duration-300 overflow-hidden border border-orange-100 flex flex-col">
                                <div class="p-4 bg-orange-50 flex justify-between items-center border-b border-orange-100">
                                    <div>
                                        <h3 class="font-bold text-lg text-secondary">${data.parentName} <span class="text-xs font-normal bg-white px-1 rounded border border-orange-200">${data.nationality}</span></h3>
                                    </div>
                                    <span class="px-2 py-1 rounded text-xs font-bold ${getRiskClass(data.riskLevel)}">
                                        ${getRiskLabel(data.riskLevel)}
                                    </span>
                                </div>
                                <div class="p-4 flex-grow space-y-2">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold text-lg">
                                            ${kid.name[0]}
                                        </div>
                                        <div>
                                            <p class="font-bold text-secondary">${kid.name}</p>
                                            <p class="text-xs text-gray-500">éª¨é½¡: ${kid.boneAge || '-'} æ­²</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-sm mt-3 bg-white p-2 rounded">
                                        <div>
                                            <p class="text-xs text-gray-400">ç›®å‰èº«é«˜</p>
                                            <p class="font-bold text-2xl">${lastLog.height} <span class="text-sm">cm</span></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400">ç¸½é•·é«˜</p>
                                            <p class="font-bold text-2xl text-riskGreen">+${growth} <span class="text-sm">cm</span> ${growthIcon}</p>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2 line-clamp-2 bg-gray-50 p-2 rounded">
                                        <i class="fa-solid fa-clipboard-list"></i> ${data.statusReport || 'æš«ç„¡å›å ±'}
                                    </p>
                                </div>
                                <div class="p-3 bg-gray-50 border-t border-gray-100">
                                    <button onclick="openFamilyModal('${doc.id}')" class="w-full bg-white border border-secondary text-secondary py-2 rounded hover:bg-secondary hover:text-white transition text-sm font-bold">
                                        ç·¨è¼¯è©³ç´°è³‡æ–™
                                    </button>
                                </div>
                            </div>
                        `;
                        container.innerHTML += html;
                    });
                }, err => {
                    console.error("Firestore ç›£è½å¤±æ•—:", err);
                    statusDiv.classList.remove('hidden');
                    statusDiv.innerHTML = `<i class="fa-solid fa-exclamation-triangle mr-2"></i> è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firestore å®‰å…¨è¦å‰‡ã€‚`;
                });
        }

        // ==========================================
        // 4. Modal ç›¸é—œåŠŸèƒ½ (å…±ç”¨)
        // ==========================================
        function openFamilyModal(id = null) {
            const form = document.getElementById('familyForm');
            form.reset();
            document.getElementById('familyId').value = id || '';
            document.getElementById('modalTitle').innerText = id ? 'ç·¨è¼¯å®¶åº­è³‡æ–™' : 'æ–°å¢å®¶åº­è³‡æ–™';
            
            document.getElementById('logMonth').value = new Date().toISOString().slice(0, 7);

            if (id) {
                db.collection('families').doc(id).get().then(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        const k = d.kids[0];
                        document.getElementById('parentName').value = d.parentName;
                        document.getElementById('nationality').value = d.nationality;
                        document.querySelector(`input[name="risk"][value="${d.riskLevel}"]`).checked = true;
                        document.getElementById('statusReport').value = d.statusReport || '';
                        
                        document.getElementById('kidName').value = k.name;
                        document.getElementById('kidDob').value = k.dob;
                        document.getElementById('kidBoneAge').value = k.boneAge || '';
                        document.getElementById('initHeight').value = k.initialHeight;
                        document.getElementById('initWeight').value = k.initialWeight;
                    }
                });
            }
            
            document.getElementById('familyModal').classList.remove('hidden');
        }

        function closeFamilyModal() {
            document.getElementById('familyModal').classList.add('hidden');
        }

        async function saveFamily(e) {
            e.preventDefault();
            const id = document.getElementById('familyId').value;
            const parentName = document.getElementById('parentName').value;
            const nationality = document.getElementById('nationality').value;
            const riskLevel = document.querySelector('input[name="risk"]:checked').value;
            const statusReport = document.getElementById('statusReport').value;
            
            const kidData = {
                name: document.getElementById('kidName').value,
                dob: document.getElementById('kidDob').value,
                boneAge: document.getElementById('kidBoneAge').value ? Number(document.getElementById('kidBoneAge').value) : null,
                initialHeight: Number(document.getElementById('initHeight').value),
                initialWeight: Number(document.getElementById('initWeight').value),
            };

            const logMonth = document.getElementById('logMonth').value;
            const logH = document.getElementById('logHeight').value;
            const logW = document.getElementById('logWeight').value;
            let newLog = null;
            if(logMonth && logH && logW) {
                newLog = { month: logMonth, height: Number(logH), weight: Number(logW), recordedAt: new Date().toISOString().split('T')[0] };
            }

            const baseData = {
                managerId: currentUser.uid,
                managerName: userData.name,
                parentName,
                nationality,
                riskLevel,
                statusReport,
                updatedAt: new Date()
            };

            try {
                if(id) {
                    const oldDoc = await db.collection('families').doc(id).get();
                    let logs = oldDoc.data().kids[0].logs || [];
                    
                    if(newLog) {
                        const existingIndex = logs.findIndex(log => log.month === newLog.month);
                        if(existingIndex > -1) {
                            logs[existingIndex] = newLog; 
                        } else {
                            logs.push(newLog); 
                        }
                    }
                    
                    kidData.logs = logs.sort((a, b) => a.month.localeCompare(b.month));
                    baseData.kids = [kidData];
                    await db.collection('families').doc(id).update(baseData);
                } else {
                    kidData.logs = newLog ? [newLog] : [];
                    baseData.kids = [kidData];
                    await db.collection('families').add(baseData);
                }
                closeFamilyModal();
            } catch (err) {
                alert("å„²å­˜å¤±æ•—: " + err.message);
            }
        }

        // ==========================================
        // 5. è€é—†åŠŸèƒ½ (Owner)
        // ==========================================
        
        async function initOwnerDashboard() {
            db.collection('users').onSnapshot(uSnap => {
                const staffDiv = document.getElementById('staffList');
                staffDiv.innerHTML = '';
                
                uSnap.forEach(doc => {
                    const u = doc.data();
                    if (u.role === 'owner') return; 
                    
                    staffDiv.innerHTML += `
                        <div class="bg-white p-4 rounded border flex justify-between items-center shadow-sm">
                            <div>
                                <p class="font-bold text-secondary">${u.name}</p>
                                <p class="text-xs text-gray-500">å¸³è™Ÿ: ${u.username}</p>
                                <span class="text-xs px-2 py-0.5 rounded ${u.role==='director'?'bg-primary text-white':'bg-gray-200 text-gray-600'}">${u.role==='director'?'ç­ä¸»ä»»':'ç®¡ç†å¸«'}</span>
                            </div>
                            <div class="flex gap-2">
                                ${u.role !== 'director' ? 
                                    `<button onclick="changeRole('${doc.id}', 'director')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">å‡é·</button>` : 
                                    `<button onclick="changeRole('${doc.id}', 'manager')" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200">é™è·</button>`
                                }
                                <button onclick="deleteStaff('${doc.id}')" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200">ç§»é™¤</button>
                            </div>
                        </div>
                    `;
                });
            });

            db.collection('families').onSnapshot(fSnap => {
                let allFamiliesCache = [];
                let stats = { total: 0, risk: 0, totalGrowth: 0, kidCount: 0, bday: 0 };
                const todayMonth = new Date().getMonth(); 

                fSnap.forEach(d => { allFamiliesCache.push({id: d.id, ...d.data()}) });

                const nations = [...new Set(allFamiliesCache.map(f => f.nationality))];
                const nationDiv = document.getElementById('nationFilters');
                nationDiv.innerHTML = '';
                nations.forEach(n => {
                    nationDiv.innerHTML += `<button onclick="filterOwnerTable('nation', '${n}', allFamiliesCache)" class="bg-white border border-secondary text-secondary px-3 py-1 rounded text-sm hover:bg-orange-50 whitespace-nowrap">${n}</button>`;
                });
                
                allFamiliesCache.forEach(f => {
                    stats.total++;
                    if(f.riskLevel === 'red') stats.risk++;
                    const k = f.kids[0];
                    const currentH = (k.logs && k.logs.length) ? k.logs[k.logs.length-1].height : k.initialHeight;
                    stats.totalGrowth += (currentH - k.initialHeight);
                    stats.kidCount++;

                    const bMonth = new Date(k.dob).getMonth(); 
                    if(bMonth === todayMonth) stats.bday++;
                });

                document.getElementById('ownerTotalFamilies').innerText = stats.total;
                document.getElementById('ownerRiskCount').innerText = stats.risk;
                document.getElementById('ownerBirthdayCount').innerText = stats.bday;
                document.getElementById('ownerAvgGrowth').innerText = stats.kidCount ? (stats.totalGrowth / stats.kidCount).toFixed(1) + " cm" : "0";

                filterOwnerTable('all', null, allFamiliesCache);
            });
        }

        async function changeRole(uid, newRole) {
            if(confirm(`ç¢ºå®šè¦è®Šæ›´æ¬Šé™ç‚º ${newRole === 'director' ? 'ç­ä¸»ä»»' : 'ç®¡ç†å¸«'} å—ï¼Ÿ`)) {
                await db.collection('users').doc(uid).update({ role: newRole });
            }
        }

        async function deleteStaff(uid) {
            if(confirm("ç¢ºå®šç§»é™¤æ­¤å“¡å·¥ï¼Ÿ(æ³¨æ„ï¼šé€™åªæœƒåˆªé™¤è³‡æ–™åº«ç´€éŒ„ï¼Œç„¡æ³•ç›´æ¥åˆªé™¤ç™»å…¥å¸³è™Ÿï¼Œéœ€è«‹å…¶å‹¿å†ç™»å…¥)")) {
                await db.collection('users').doc(uid).delete();
            }
        }

        function filterOwnerTable(type, val, allFamiliesCache) {
            const tbody = document.getElementById('ownerFamilyTable');
            tbody.innerHTML = '';
            
            let filtered = allFamiliesCache || [];
            if (type === 'risk') filtered = filtered.filter(f => f.riskLevel === 'red');
            if (type === 'nation') filtered = filtered.filter(f => f.nationality === val);

            const todayMonth = new Date().getMonth(); 

            filtered.forEach(f => {
                const k = f.kids[0];
                const currentH = (k.logs && k.logs.length) ? k.logs[k.logs.length-1].height : k.initialHeight;
                const grow = (currentH - k.initialHeight).toFixed(1);
                const bMonth = new Date(k.dob).getMonth();
                const isBday = bMonth === todayMonth;

                tbody.innerHTML += `
                    <tr class="hover:bg-orange-50 transition border-b border-orange-50">
                        <td class="p-3 font-bold text-gray-600">${f.nationality}</td>
                        <td class="p-3">
                            <div class="font-bold">${k.name}</div>
                            <div class="text-xs text-gray-400">${k.dob} ${isBday ? '<i class="fa-solid fa-cake-candles text-primary animate-bounce ml-1"></i>' : ''}</div>
                        </td>
                        <td class="p-3">
                            <div>${currentH} cm</div>
                            <div class="text-xs text-riskGreen font-bold">+${grow} cm</div>
                        </td>
                        <td class="p-3 text-sm">${f.managerName}</td>
                        <td class="p-3 text-center"><span class="risk-dot ${getRiskDotClass(f.riskLevel)}"></span></td>
                    </tr>
                `;
            });
        }

        // ==========================================
        // 6. ç­ä¸»ä»»åŠŸèƒ½ (Director)
        // ==========================================
        async function initDirectorDashboard() {
             db.collection('families').onSnapshot(fSnap => {
                const teamDiv = document.getElementById('directorTeamList');
                const riskDiv = document.getElementById('directorRiskList');
                
                teamDiv.innerHTML = '';
                riskDiv.innerHTML = '';

                let managerStats = {};
                
                fSnap.forEach(doc => {
                    const d = doc.data();
                    const k = d.kids[0];
                    const lastH = (k.logs && k.logs.length) ? k.logs[k.logs.length-1].height : k.initialHeight;

                    if(!managerStats[d.managerId]) managerStats[d.managerId] = { name: d.managerName, total: 0, stable: 0, risk: 0 };
                    managerStats[d.managerId].total++;
                    if(d.riskLevel === 'green') managerStats[d.managerId].stable++;
                    
                    if(d.riskLevel === 'red' || d.riskLevel === 'yellow') {
                        riskDiv.innerHTML += `
                            <div class="p-3 border-l-4 ${d.riskLevel==='red'?'border-riskRed bg-red-50':'border-riskYellow bg-yellow-50'} rounded shadow-sm flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-secondary">${d.parentName} (${d.kids[0].name})</p>
                                    <p class="text-xs text-gray-500">è² è²¬äºº: ${d.managerName}</p>
                                    <p class="text-xs text-gray-500">éª¨é½¡: ${k.boneAge || '-'} / èº«é«˜: ${lastH}cm</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-bold px-2 py-1 bg-white rounded shadow-sm">${d.riskLevel==='red'?'é«˜é¢¨éšª':'è§€å¯Ÿ'}</span>
                                    <p class="text-xs text-gray-400 mt-1">${d.statusReport || 'ç„¡å›å ±'}</p>
                                </div>
                            </div>
                        `;
                    }
                });

                Object.values(managerStats).forEach(m => {
                    const percent = Math.round((m.stable/m.total)*100);
                    teamDiv.innerHTML += `
                        <div class="bg-white p-4 rounded border border-orange-100 flex justify-between items-center shadow-sm">
                            <div>
                                <p class="font-bold text-lg text-secondary">${m.name}</p>
                                <p class="text-xs text-gray-500">ç®¡ç† ${m.total} æˆ¶å®¶åº­</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold ${percent < 60 ? 'text-riskRed' : 'text-riskGreen'}">${percent}%</p>
                                <p class="text-xs text-gray-400">ç©©å®šç‡</p>
                            </div>
                        </div>
                    `;
                });
                
                if(riskDiv.innerHTML === '') riskDiv.innerHTML = '<p class="text-gray-400 text-center py-4">ç›®å‰ç„¡é ˆé—œæ³¨çš„é¢¨éšªå®¶åº­</p>';
            });
        }

        // Helper classes
        function getRiskClass(level) {
            if(level === 'red') return 'bg-red-100 text-riskRed';
            if(level === 'yellow') return 'bg-yellow-100 text-riskYellow';
            return 'bg-green-100 text-riskGreen';
        }
        function getRiskLabel(level) {
            if(level === 'red') return 'é«˜é¢¨éšª';
            if(level === 'yellow') return 'è§€å¯Ÿä¸­';
            return 'ç©©å®š';
        }
        function getRiskDotClass(level) {
            if(level === 'red') return 'bg-riskRed';
            if(level === 'yellow') return 'bg-riskYellow';
            return 'bg-riskGreen';
        }

    </script>
</body>
</html>