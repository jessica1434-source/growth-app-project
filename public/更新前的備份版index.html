<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…’ç«¥ç”Ÿé•·ç®¡ç†ç³»çµ± (çµ‚æ¥µä¿®æ­£ç‰ˆV27 - éª¨é½¡æ›´æ–°ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#FAE9C2', card: '#FFFFF0', primary: '#FF9800', secondary: '#BECCE4',
                        accent: '#FFB74D', riskRed: '#D32F2F', riskYellow: '#FBC02D', riskGreen: '#388E3C',
                        infoBlue: '#BBDEFB', infoDark: '#1976D2',
                        excellentBg: '#ECFDF5', excellentBorder: '#10B981', excellentText: '#065F46',
                        adminPurple: '#7E22CE', adminBg: '#F3E8FF'
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #FAE9C2; color: #000; padding-bottom: 200px; }
        .hidden { display: none !important; }
        .risk-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .tab-btn { border-bottom: 3px solid transparent; opacity: 0.6; font-weight: bold; color: #555; }
        .tab-btn.active { border-bottom: 3px solid #FF9800; opacity: 1; color: #000; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #FFB74D; border-radius: 3px; }

        .marked-for-deletion {
            background-color: #fee2e2 !important;
            opacity: 0.6;
            text-decoration: line-through;
            border: 1px dashed #ef4444 !important;
        }
        .marked-for-deletion input { pointer-events: none; background-color: transparent; }

        /* è¼‰å…¥é®ç½© */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 9999; display: none;
            justify-content: center; align-items: center; color: white; font-size: 1.5rem; font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="loadingOverlay"><i class="fa-solid fa-spinner fa-spin mr-2"></i> è™•ç†ä¸­...</div>

    <div id="undoToast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-2xl z-[9999] flex items-center gap-4 hidden transition-opacity duration-300">
        <span id="undoMessage">å·²åˆªé™¤</span>
        <button onclick="executeUndo()" class="bg-yellow-500 text-black px-3 py-1 rounded font-bold hover:bg-yellow-400 transition"><i class="fa-solid fa-rotate-left"></i> å¾©åŸ</button>
        <button onclick="closeToast()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
    </div>

    <nav class="bg-secondary text-gray-800 p-4 shadow-md flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center gap-2"><i class="fa-solid fa-sun text-yellow-600 text-xl animate-pulse"></i><h1 class="text-xl font-bold tracking-wide">å…’ç«¥ç”Ÿé•·ç®¡ç†ç³»çµ±</h1></div>
        <div id="navUser" class="hidden flex items-center gap-3">
            <div class="text-right leading-tight"><span id="userRoleDisplay" class="block text-xs bg-primary text-white px-1 rounded inline-block mb-1"></span><span id="userNameDisplay" class="text-sm font-bold"></span></div>
            <button onclick="logout()" class="bg-white text-gray-800 px-3 py-2 rounded hover:bg-gray-100 transition text-sm font-bold border border-gray-400"><i class="fa-solid fa-sign-out-alt"></i> ç™»å‡º</button>
        </div>
    </nav>

    <div id="adminToolbar" class="hidden bg-adminPurple text-white p-2 flex flex-wrap justify-center items-center gap-4 shadow-inner sticky top-[72px] z-30">
        <span class="font-bold text-sm"><i class="fa-solid fa-user-secret mr-1"></i> è¦–è§’åˆ‡æ›ï¼š</span>
        <div class="flex gap-2">
            <button onclick="switchView('owner')" class="px-3 py-1 bg-white text-adminPurple rounded font-bold text-xs hover:bg-gray-200 transition shadow">è€é—†è¦–è§’</button>
            <button onclick="switchView('director')" class="px-3 py-1 bg-purple-400 text-white rounded font-bold text-xs hover:bg-purple-500 transition shadow">ç­ä¸»ä»»è¦–è§’</button>
            <button onclick="switchView('manager')" class="px-3 py-1 bg-purple-400 text-white rounded font-bold text-xs hover:bg-purple-500 transition shadow">ç®¡ç†å¸«è¦–è§’</button>
        </div>
    </div>

    <main class="flex-grow p-4 md:p-6 max-w-7xl mx-auto w-full">
        
        <div id="authSection" class="max-w-md mx-auto bg-card p-0 rounded-xl shadow-xl mt-10 overflow-hidden border border-gray-300">
            <div class="flex bg-white border-b">
                <button onclick="switchAuthTab('login')" id="tab-login" class="tab-btn active flex-1 py-4 text-center transition">ç™»å…¥ç³»çµ±</button>
                <button onclick="switchAuthTab('register')" id="tab-register" class="tab-btn flex-1 py-4 text-center transition">è¨»å†Šå¸³è™Ÿ</button>
            </div>
            <div class="p-8">
                <form id="loginForm" onsubmit="handleAuth(event, 'login')" class="space-y-6">
                    <div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-800">æ­¡è¿å›ä¾†</h2></div>
                    <div><label class="block text-sm font-bold mb-2 text-gray-700">å¸³è™Ÿ / Email</label><input type="text" id="loginId" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="è¼¸å…¥å¸³è™Ÿæˆ–å®Œæ•´ Email" required></div>
                    <div><label class="block text-sm font-bold mb-2 text-gray-700">å¯†ç¢¼</label><input type="password" id="loginPwd" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                    <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-orange-600 transition font-bold shadow-md text-lg">ç™»å…¥</button>
                    <div class="text-center">
                        <button type="button" onclick="forgotPassword()" class="text-sm text-blue-600 hover:underline">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</button>
                    </div>
                </form>
                <form id="registerForm" onsubmit="handleAuth(event, 'register')" class="space-y-4 hidden">
                    <div class="bg-blue-50 p-4 rounded text-sm text-blue-800 mb-4 border-l-4 border-blue-500"><p class="font-bold">æ–°é€²äººå“¡è¨»å†Š</p><p>å»ºè­°ä½¿ç”¨çœŸå¯¦ Email è¨»å†Šï¼Œä»¥ä¾¿æ—¥å¾Œè‡ªè¡Œæ‰¾å›å¯†ç¢¼ã€‚</p></div>
                    <div><label class="block text-sm font-bold mb-1 text-gray-700">å§“å</label><input type="text" id="regName" class="w-full p-3 border border-gray-300 rounded" required></div>
                    <div><label class="block text-sm font-bold mb-1 text-gray-700">è‡ªè¨‚å¸³è™Ÿ æˆ– Email</label><input type="text" id="regId" class="w-full p-3 border border-gray-300 rounded" placeholder="ä¾‹: martin æˆ– martin@gmail.com" required></div>
                    <div><label class="block text-sm font-bold mb-1 text-gray-700">è‡ªè¨‚å¯†ç¢¼</label><input type="password" id="regPwd" class="w-full p-3 border border-gray-300 rounded" required></div>
                    <button type="submit" class="w-full bg-secondary text-black py-3 rounded hover:bg-blue-300 transition font-bold shadow-md">å»ºç«‹å¸³è™Ÿ</button>
                </form>
            </div>
        </div>

        <div id="ownerDashboard" class="hidden space-y-6 animate-fade-in">
           <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-lg shadow border-l-4 border-secondary">
                    <h3 class="text-gray-500 text-sm font-bold">ç¸½å®¶åº­æ•¸</h3>
                    <p class="text-4xl font-bold text-gray-800 mt-2" id="ownerTotalFamilies">0</p>
                </div>
                
                <div class="bg-white p-5 rounded-lg shadow border-l-4 border-excellentBorder">
                    <h3 class="text-gray-500 text-sm font-bold">å“è¶Šæˆé•· (æ¦®è­½æ¦œ)</h3>
                    <p class="text-4xl font-bold text-excellentText mt-2" id="ownerExcellentCount">0</p>
                    <div id="ownerExcellentList" class="mt-2 text-sm text-gray-800 font-bold bg-green-50 p-1 rounded h-16 overflow-y-auto scrollbar-thin border border-green-100 leading-relaxed">
                        ç„¡
                    </div>
                </div>

                <div class="bg-white p-5 rounded-lg shadow border-l-4 border-riskRed">
                    <h3 class="text-gray-500 text-sm font-bold">é«˜é¢¨éšªå®¶åº­</h3>
                    <p class="text-4xl font-bold text-riskRed mt-2" id="ownerRiskCount">0</p>
                    <div id="ownerRiskList" class="mt-2 text-sm text-gray-800 font-bold bg-red-50 p-1 rounded h-16 overflow-y-auto scrollbar-thin border border-red-100 leading-relaxed">
                        ç„¡
                    </div>
                </div>

                <div class="bg-white p-5 rounded-lg shadow border-l-4 border-primary relative">
                    <h3 class="text-gray-500 text-sm font-bold">ç•¶æœˆå£½æ˜Ÿ</h3>
                    <p class="text-4xl font-bold text-primary mt-2" id="ownerBirthdayCount">0</p>
                    <div id="ownerBirthdayList" class="mt-2 text-sm text-gray-800 font-bold bg-yellow-50 p-1 rounded h-16 overflow-y-auto scrollbar-thin border border-yellow-100 leading-relaxed">
                        ç„¡
                    </div>
                </div>
            </div>
            
            <div id="ownerHealthBoard" class="mb-6 p-4 rounded shadow-sm border-l-4 border-red-500 bg-red-50 hidden">
                <div class="flex items-center">
                    <div id="ownerHealthIcon" class="flex-shrink-0 text-2xl text-red-600"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <div class="ml-4 w-full">
                        <h3 id="ownerHealthTitle" class="text-lg font-bold text-red-800">è­¦ç¤ºï¼šåŠ å…¥æ»¿4å€‹æœˆä»æœªé•·é«˜</h3>
                        <div id="ownerStagnantList" class="text-sm mt-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-1 text-red-700 font-bold"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                <h3 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-chart-pie text-secondary"></i> å„åœ‹ç±æˆæ•ˆåˆ†æ
                </h3>
                <div class="w-full h-64 md:h-80">
                    <canvas id="countryGrowthChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-2">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-list"></i> å…¨æ©Ÿæ§‹å®¶åº­æ˜ç´°</h3>
                    
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <select id="ownerCountryFilter" onchange="renderOwnerTable()" class="border p-2 rounded text-sm font-bold text-gray-700 bg-gray-50 focus:outline-none focus:border-primary">
                            <option value="ALL">ğŸŒ æ‰€æœ‰åœ‹ç±</option>
                        </select>
                        <input type="text" id="ownerSearch" placeholder="ğŸ” æœå°‹å§“å..." class="border p-2 rounded text-sm w-full md:w-48 focus:outline-none focus:border-primary" oninput="renderOwnerTable()">
                    </div>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-gray-700 text-sm">
                                <th class="p-3">åœ‹ç±</th>
                                <th class="p-3">å®¶é•·å§“å</th>
                                <th class="p-3">å­©ç«¥/ç”Ÿæ—¥</th>
                                <th class="p-3">ç”Ÿé•·æ•¸æ“š</th>
                                <th class="p-3">è² è²¬ç®¡ç†å¸«</th>
                                <th class="p-3 text-center">é¢¨éšª</th>
                                <th class="p-3 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="ownerFamilyTable" class="text-sm bg-white divide-y divide-gray-100 text-gray-800"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                <h3 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2"><i class="fa-solid fa-users-gear"></i> äººå“¡æ¬Šé™ç®¡ç†èˆ‡ç­ä¸»ä»»åˆ†é…</h3>
                <div id="staffList" class="flex flex-col gap-3"></div>
            </div>
        </div>

        <div id="directorDashboard" class="hidden space-y-6">
            <div id="directorHealthBoard" class="mb-6 p-4 rounded shadow-sm border-l-4 border-red-500 bg-red-50 hidden">
                <div class="flex items-center">
                    <div id="directorHealthIcon" class="flex-shrink-0 text-2xl text-red-600"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <div class="ml-4 w-full">
                        <h3 id="directorHealthTitle" class="text-lg font-bold text-red-800">è­¦ç¤ºï¼šåŠ å…¥æ»¿4å€‹æœˆä»æœªé•·é«˜</h3>
                        <div id="directorStagnantList" class="text-sm mt-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-1 text-red-700 font-bold"></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4 border-l-4 border-primary">
                <div><h2 class="text-2xl font-bold text-gray-800">æˆ‘çš„ç®¡ç†å®¶åº­</h2><p class="text-gray-500 text-sm">è¦ªè‡ªè² è²¬çš„å€‹æ¡ˆç®¡ç†</p></div>
                <div class="flex items-center gap-3">
                    <input type="text" id="directorMySearch" placeholder="ğŸ” æœå°‹å®¶åº­..." class="border p-2 rounded text-sm w-32 md:w-48 focus:outline-none focus:border-primary shadow-inner" oninput="renderDirectorMyFamilyList()">
                    <button onclick="openFamilyModal()" class="bg-primary text-white px-5 py-2 rounded-full shadow hover:bg-orange-600 font-bold flex items-center gap-2 whitespace-nowrap"><i class="fa-solid fa-plus"></i> æ–°å¢</button>
                </div>
            </div>
            <div id="directorMyFamilyList" class="flex flex-col gap-3 mb-8"></div>

            <div class="bg-yellow-100 border-l-4 border-primary text-yellow-800 p-4 rounded shadow-sm"><p class="font-bold">ç­ä¸»ä»»ç£å°æ¨¡å¼</p><p class="text-sm">åƒ…ä¾›æª¢è¦–æ——ä¸‹ç®¡ç†å¸«ç¸¾æ•ˆèˆ‡å®¶åº­ç‹€æ³ (ç„¡æ³•ç·¨è¼¯)ã€‚</p></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow h-fit border border-gray-200"><h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">æ——ä¸‹ç®¡ç†å¸«è¡¨ç¾</h3><div id="directorTeamList" class="space-y-3"></div></div>
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200"><h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">éœ€é—œæ³¨å®¶åº­ (ç´…/é»ƒç‡ˆ)</h3><div id="directorRiskList" class="space-y-3 max-h-[500px] overflow-y-auto"></div></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border border-gray-200"><h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">å…¨æ©Ÿæ§‹å®¶åº­è³‡æ–™åˆ—è¡¨</h3><div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-gray-100 text-gray-700 text-sm"><th class="p-3">åœ‹ç±</th><th class="p-3">å­©ç«¥/ç”Ÿæ—¥</th><th class="p-3">ç”Ÿé•·æ•¸æ“š</th><th class="p-3">è² è²¬äººå“¡</th><th class="p-3 text-center">é¢¨éšª</th><th class="p-3 text-center">æ“ä½œ</th></tr></thead><tbody id="directorFamilyTable" class="text-sm bg-white divide-y divide-gray-100 text-gray-800"></tbody></table></div></div>
        </div>

        <div id="managerDashboard" class="hidden space-y-6 animate-fade-in">
            <div id="managerExcellentSection" class="hidden bg-excellentBg border-l-4 border-excellentBorder p-5 rounded-lg shadow-sm">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fa-solid fa-trophy text-yellow-500 text-xl animate-bounce"></i>
                    <h3 class="text-xl font-bold text-excellentText">å“è¶Šæˆé•·æ¦®è­½æ¦œ</h3>
                    <span class="text-xs bg-white text-excellentText px-2 py-1 rounded border border-excellentBorder">æ¨™æº–ï¼š3å€‹æœˆé•·1.98cm æˆ– é€Ÿç‡0.66/æœˆ</span>
                </div>
                <div id="managerExcellentList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-5 rounded-lg shadow border-l-4 border-secondary"><h3 class="text-gray-500 text-sm font-bold">ç®¡ç†å®¶åº­æ•¸</h3><p class="text-4xl font-bold text-gray-800 mt-2" id="managerTotalCount">0</p></div>
                <div class="bg-white p-5 rounded-lg shadow border-l-4 border-primary"><h3 class="text-gray-500 text-sm font-bold">ç•¶æœˆå£½æ˜Ÿ</h3><p class="text-4xl font-bold text-primary mt-2" id="managerBirthdayCount">0</p><div id="managerBirthdayList" class="mt-2 text-sm text-gray-800 font-bold bg-yellow-50 p-1 rounded h-12 overflow-y-auto scrollbar-thin border border-yellow-100">ç„¡</div></div>
            </div>

            <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
                <div><h2 class="text-2xl font-bold text-gray-800">æˆ‘çš„å®¶åº­ç®¡ç†</h2></div>
                <div class="flex items-center gap-3">
                    <input type="text" id="managerSearch" placeholder="ğŸ” æœå°‹å®¶åº­..." class="border p-2 rounded text-sm w-32 md:w-48 focus:outline-none focus:border-primary shadow-inner" oninput="initManagerDashboard()">
                    <button onclick="openFamilyModal()" class="bg-primary text-white px-5 py-2 rounded-full shadow hover:bg-orange-600 font-bold flex items-center gap-2 whitespace-nowrap"><i class="fa-solid fa-plus"></i> æ–°å¢</button>
                </div>
            </div>
            <div id="managerFamilyList" class="flex flex-col gap-3"></div>
        </div>
    </main>

    <div id="transferModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-md shadow-2xl p-6 border-t-8 border-infoDark">
            <h3 id="transferModalTitle" class="text-xl font-bold mb-4 text-gray-800">ç§»äº¤å®¶åº­</h3>
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">æ–°è² è²¬äºº</label>
                <select id="targetManagerSelect" class="w-full border p-3 rounded bg-infoBlue focus:bg-white outline-none text-black"></select>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('transferModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-bold">å–æ¶ˆ</button>
                <button onclick="confirmTransfer()" class="px-4 py-2 bg-infoDark text-white rounded hover:bg-blue-700 font-bold shadow">ç¢ºèªç§»äº¤</button>
            </div>
        </div>
    </div>

    <div id="familyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-4xl shadow-2xl relative max-h-[90vh] overflow-y-auto border-t-8 border-primary">
            <button onclick="closeFamilyModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-600 w-8 h-8 flex items-center justify-center rounded-full"><i class="fa-solid fa-times text-xl"></i></button>
            <div class="p-6 md:p-8">
                <h3 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">å®¶åº­è³‡æ–™</h3>
                <form id="familyForm" onsubmit="saveFamily(event)" class="space-y-6 p-6">
                    <input type="hidden" id="familyId">
                    
                    <div class="flex border-b border-gray-200 mb-4">
                        <button type="button" onclick="switchModalTab('basic')" id="tab-basic" class="px-4 py-2 text-sm font-bold text-primary border-b-2 border-primary">åŸºæœ¬è³‡æ–™</button>
                        <button type="button" onclick="switchModalTab('records')" id="tab-records" class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-primary">ç´€éŒ„èˆ‡è¿½è¹¤</button>
                    </div>

                    <div id="content-basic" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="block text-sm font-bold text-gray-700 mb-1">å®¶é•·å§“å</label><input type="text" id="parentName" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-primary outline-none" required></div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">åœ‹ç±/åœ°å€</label>
                                <input type="text" id="nationality" list="nationalityList" class="w-full border p-3 rounded-lg bg-white focus:ring-2 focus:ring-primary outline-none" placeholder="è«‹é¸æ“‡æˆ–è¼¸å…¥" required>
                                <datalist id="nationalityList">
                                    <option value="å°ç£">
                                    <option value="è¶Šå—">
                                    <option value="å°å°¼">
                                    <option value="è²å¾‹è³“">
                                    <option value="æ³°åœ‹">
                                    <option value="é¦¬ä¾†è¥¿äº">
                                    <option value="ä¸­åœ‹">
                                    <option value="æ—¥æœ¬">
                                    <option value="éŸ“åœ‹">
                                    <option value="ç¾åœ‹">
                                </datalist>
                            </div>

                            <div><label class="block text-sm font-bold text-gray-700 mb-1">åŠ å…¥æ—¥æœŸ</label><input type="date" id="joinDate" class="w-full border p-3 rounded-lg" max="9999-12-31"></div>
                            
                            <div><label class="block text-sm font-bold text-gray-700 mb-1">ç®¡ç†æˆªæ­¢æ—¥æœŸ</label><input type="date" id="deadlineDate" class="w-full border p-3 rounded-lg" max="9999-12-31"></div>

                            <div class="flex items-center pt-2"><input type="checkbox" id="isRenewal" class="w-5 h-5 text-primary"><label for="isRenewal" class="ml-2 font-bold text-gray-700">æ˜¯å¦ç‚ºçºŒç´„æˆ¶</label></div>
                        </div>

                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-100">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-bold text-gray-800">å­©ç«¥åå–®</label>
                                <button type="button" id="btnAddKid" onclick="addKidField()" class="text-xs bg-white border border-gray-300 px-2 py-1 rounded hover:bg-gray-50 font-bold text-primary"><i class="fa-solid fa-plus"></i> æ–°å¢å­©ç«¥</button>
                            </div>
                            <div id="kidsContainer"></div>
                        </div>
                    </div>

                    <div id="content-records" class="hidden space-y-6">
                        <div class="bg-yellow-50 p-4 rounded mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">é¸æ“‡å­©ç«¥</label>
                                    <select id="recordKidSelect" class="w-full border p-2 rounded" onchange="renderKidLogs()"></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">é¢¨éšªç­‰ç´šè©•ä¼°</label>
                                    <div class="flex gap-4 bg-white p-2 rounded border border-yellow-200">
                                        <label class="flex items-center cursor-pointer"><input type="radio" name="risk" value="green" checked class="w-4 h-4 text-green-600"> <span class="ml-2 text-green-700 font-bold text-sm">ç©©å®š</span></label>
                                        <label class="flex items-center cursor-pointer"><input type="radio" name="risk" value="yellow" class="w-4 h-4 text-yellow-500"> <span class="ml-2 text-yellow-600 font-bold text-sm">è§€å¯Ÿ</span></label>
                                        <label class="flex items-center cursor-pointer"><input type="radio" name="risk" value="red" class="w-4 h-4 text-red-600"> <span class="ml-2 text-red-700 font-bold text-sm">é«˜éšª</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded border border-gray-200 shadow-sm" id="logFormContainer">
                            <h5 class="font-bold text-gray-800 mb-3 border-b pb-1">æ–°å¢ç´€éŒ„</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                <div><label class="text-xs text-gray-500">æ—¥æœŸ</label><input type="date" id="logDate" class="w-full border p-1 rounded text-sm" max="9999-12-31"></div>
                                <div><label class="text-xs text-gray-500">èº«é«˜ (cm)</label><div class="flex items-center gap-1"><input type="number" step="0.1" id="logHeight" class="w-full border p-1 rounded text-sm"><span id="heightTrend" class="text-[10px] font-bold w-12"></span></div></div>
                                <div><label class="text-xs text-gray-500">é«”é‡ (kg)</label><input type="number" step="0.1" id="logWeight" class="w-full border p-1 rounded text-sm"></div>
                                <div><label class="text-xs text-gray-500">èŒ¶åŒ… (åŒ…)</label><select id="logTeaBags" class="w-full border p-1 rounded text-sm bg-white"><option value="">ç„¡</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
                            </div>
                            <div class="grid grid-cols-3 gap-3 mb-3">
                                <div><label class="text-xs text-gray-500">æ¨æ‹¿ (æ¬¡)</label><input type="text" id="logMassage" class="w-full border p-1 rounded text-sm"></div>
                                <div><label class="text-xs text-gray-500">ç©´é“ (æ¬¡)</label><input type="text" id="logAcupoint" class="w-full border p-1 rounded text-sm"></div>
                                <div><label class="text-xs text-gray-500">é‹å‹• (æ¬¡)</label><input type="text" id="logExercise" class="w-full border p-1 rounded text-sm"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-3 mb-3">
                                <div class="bg-orange-50 p-2 rounded"><label class="text-xs text-gray-500">å¿Œå£æƒ…å½¢</label><div class="flex gap-2"><label><input type="radio" name="diet" value="å¾ˆå¥½"> å¾ˆå¥½</label><label><input type="radio" name="diet" value="æ™®é€š"> æ™®é€š</label><label><input type="radio" name="diet" value="æ²’æœ‰"> æ²’æœ‰</label></div></div>
                            </div>
                            <div class="mb-3"><label class="text-xs text-gray-500">ç‹€æ³å›å ±</label><textarea id="logStatus" class="w-full border p-1 rounded text-sm h-12"></textarea></div>
                            <button type="button" id="btnSaveLog" onclick="saveLogDirectly()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 font-bold text-sm shadow">å„²å­˜ç´€éŒ„</button>
                        </div>
                        
                        <div class="bg-white rounded border border-gray-200 overflow-hidden">
                            <div class="bg-gray-100 p-2 font-bold text-xs text-gray-600">æ­·å²ç´€éŒ„</div>
                            <div id="logsHistoryTable" class="max-h-64 overflow-y-auto scrollbar-thin"></div>
                        </div>
                    </div>

                    <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end" id="modalFooterBtn">
                        <button type="submit" class="bg-secondary text-black px-8 py-3 rounded-lg font-bold text-lg shadow-lg hover:opacity-90 w-full md:w-auto">å„²å­˜åŸºæœ¬è³‡æ–™</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="singleTransferModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-md shadow-2xl p-6 border-t-8 border-purple-600">
            <h3 class="text-xl font-bold mb-2 text-gray-800">å–®ä¸€å®¶åº­ç§»äº¤</h3>
            <p id="singleTransferTargetName" class="text-sm text-gray-500 mb-4 font-bold border-b pb-2"></p>
            
            <input type="hidden" id="transferFamilyId">
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">æŒ‡æ´¾æ–°è² è²¬äºº</label>
                <select id="singleTargetManagerSelect" class="w-full border p-3 rounded bg-purple-50 focus:bg-white outline-none text-black font-bold">
                </select>
            </div>
            
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('singleTransferModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-bold">å–æ¶ˆ</button>
                <button onclick="confirmSingleTransfer()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 font-bold shadow"><i class="fa-solid fa-right-left"></i> ç¢ºèªç§»äº¤</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }

        // === 1. Firebase åˆå§‹åŒ– ===
        const firebaseConfig = { apiKey: "AIzaSyBS8RCrZArtOLddiTSK8zt5VD2ODuYxLoA", authDomain: "j-growth-app-new.firebaseapp.com", projectId: "j-growth-app-new", storageBucket: "j-growth-app-new.appspot.com", messagingSenderId: "573660567724", appId: "1:573660567724:web:f8464351a96e276112a709", measurementId: "G-TBE5PXCXWT" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null, userData = null, currentEditingFamily = null;
        const FAKE_DOMAIN = "@growth.system"; 
        let undoTimeout = null, pendingUndoAction = null;
        let ownerFamiliesCache = [];
        let allStaffCache = []; 
        let directorsCache = []; 
        let directorPersonalCache = [];
        let isModalReadOnly = false; 
        let countryChartInstance = null; // V13: åœ–è¡¨å¯¦ä¾‹

        // V20: è³‡æ–™è¼‰å…¥ç‹€æ…‹æ——æ¨™ï¼Œé¿å…åˆ‡æ›è¦–è§’æ™‚é‡è¤‡ç›£è½
        let isOwnerInit = false, isDirectorInit = false, isManagerInit = false;

        // === 2. ç™»å…¥ç‹€æ…‹ ===
        auth.onAuthStateChanged(async (user) => { 
            if (user) { 
                try { 
                    let doc = await db.collection('users').doc(user.uid).get(); 
                    if (!doc.exists) {
                        await new Promise(r => setTimeout(r, 1500)); 
                        doc = await db.collection('users').doc(user.uid).get();
                    }

                    if (doc.exists) { 
                        userData = doc.data(); 
                        currentUser = user; 
                        
                        document.getElementById('authSection').classList.add('hidden'); 
                        document.getElementById('navUser').classList.remove('hidden'); 
                        document.getElementById('navUser').classList.add('flex'); 
                        
                        let roleName = 'ç®¡ç†å¸«';
                        let roleBg = 'bg-primary';
                        
                        if (userData.role === 'owner') roleName = 'è€é—†';
                        else if (userData.role === 'admin') { roleName = 'ç¨‹å¼ç®¡ç†è€…'; roleBg = 'bg-adminPurple'; }
                        else if (userData.role === 'director') roleName = 'ç­ä¸»ä»»';
                        
                        const roleBadge = document.getElementById('userRoleDisplay');
                        roleBadge.innerText = roleName;
                        roleBadge.className = `block text-xs ${roleBg} text-white px-1 rounded inline-block mb-1`;
                        document.getElementById('userNameDisplay').innerText = userData.name; 
                        
                        // V21 ä¿®æ­£: ç¨‹å¼ç®¡ç†è€… (Admin) èˆ‡ è€é—† (Owner) éƒ½èƒ½çœ‹åˆ°åˆ‡æ›åˆ—
                        if (userData.role === 'admin' || userData.role === 'owner') {
                            document.getElementById('adminToolbar').classList.remove('hidden');
                            switchView('owner'); // é è¨­é€²è€é—†è¦–è§’
                        } else if (userData.role === 'director') {
                            initDirectorDashboard(); document.getElementById('directorDashboard').classList.remove('hidden');
                        } else { 
                            initManagerDashboard(); document.getElementById('managerDashboard').classList.remove('hidden'); 
                        } 
                    }
                } catch (error) { console.error(error); } 
            } else { 
                document.getElementById('authSection').classList.remove('hidden'); 
                document.getElementById('navUser').classList.add('hidden'); 
                ['ownerDashboard','directorDashboard','managerDashboard'].forEach(id => document.getElementById(id).classList.add('hidden')); 
            } 
        });

        // V20: åˆ‡æ›è¦–è§’åŠŸèƒ½
        function switchView(view) {
            ['ownerDashboard','directorDashboard','managerDashboard'].forEach(id => document.getElementById(id).classList.add('hidden'));
            const buttons = document.getElementById('adminToolbar').querySelectorAll('button');
            buttons.forEach(b => {
                b.classList.remove('bg-white', 'text-adminPurple');
                b.classList.add('bg-purple-400', 'text-white');
            });

            if (view === 'owner') {
                document.getElementById('ownerDashboard').classList.remove('hidden');
                initOwnerDashboard();
                buttons[0].classList.remove('bg-purple-400', 'text-white');
                buttons[0].classList.add('bg-white', 'text-adminPurple');
            } else if (view === 'director') {
                document.getElementById('directorDashboard').classList.remove('hidden');
                initDirectorDashboard();
                buttons[1].classList.remove('bg-purple-400', 'text-white');
                buttons[1].classList.add('bg-white', 'text-adminPurple');
            } else if (view === 'manager') {
                document.getElementById('managerDashboard').classList.remove('hidden');
                initManagerDashboard();
                buttons[2].classList.remove('bg-purple-400', 'text-white');
                buttons[2].classList.add('bg-white', 'text-adminPurple');
            }
        }

        // === 3. ç™»å…¥è¨»å†Š ===
        async function handleAuth(e, type) { 
            e.preventDefault(); 
            showLoading(true);
            try { 
                let idInput = type === 'login' ? document.getElementById('loginId').value.trim() : document.getElementById('regId').value.trim().toLowerCase();
                const pwdInput = type === 'login' ? document.getElementById('loginPwd').value : document.getElementById('regPwd').value;
                
                // V19: æ··åˆæ¨¡å¼ - å¦‚æœè¼¸å…¥å€¼åŒ…å« @ å°±ç•¶ä½œ Emailï¼Œå¦å‰‡åŠ ä¸Šå‡ç¶²åŸŸ
                const finalEmail = idInput.includes('@') ? idInput : idInput + FAKE_DOMAIN;

                if (type === 'login') { 
                    await auth.signInWithEmailAndPassword(finalEmail, pwdInput); 
                } else { 
                    const cred = await auth.createUserWithEmailAndPassword(finalEmail, pwdInput); 
                    const usersSnap = await db.collection('users').get(); 
                    await db.collection('users').doc(cred.user.uid).set({ 
                        name: document.getElementById('regName').value.trim(), 
                        username: idInput, 
                        role: usersSnap.empty ? 'owner' : 'manager', 
                        createdAt: new Date() 
                    }); 
                    alert('è¨»å†ŠæˆåŠŸï¼ç³»çµ±å°‡é‡æ–°æ•´ç†...'); 
                    location.reload(); 
                } 
                showLoading(false);
            } catch (err) { 
                showLoading(false);
                alert("æ“ä½œå¤±æ•—: " + err.message); 
            } 
        }

        // V19: å¿˜è¨˜å¯†ç¢¼åŠŸèƒ½
        function forgotPassword() {
            const email = prompt("è«‹è¼¸å…¥æ‚¨è¨»å†Šæ™‚çš„å®Œæ•´ Emailï¼š\n(åƒ…é©ç”¨æ–¼ä½¿ç”¨çœŸå¯¦ Email è¨»å†Šçš„å¸³è™Ÿ)");
            if (email) {
                if (!email.includes('@')) {
                    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email æ ¼å¼");
                    return;
                }
                showLoading(true);
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        showLoading(false);
                        alert("é‡è¨­å¯†ç¢¼ä¿¡å·²ç™¼é€ï¼è«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±ã€‚");
                    })
                    .catch((error) => {
                        showLoading(false);
                        if (error.code === 'auth/user-not-found') {
                            alert("æ‰¾ä¸åˆ°æ­¤ Email çš„ä½¿ç”¨è€…ã€‚å¦‚æœæ‚¨æ˜¯ä½¿ç”¨è‡ªè¨‚å¸³è™Ÿ(å¦‚ martin)ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡é‡ç½®ã€‚");
                        } else {
                            alert("ç™¼é€å¤±æ•—ï¼š" + error.message);
                        }
                    });
            }
        }

        function logout() { auth.signOut(); location.reload(); }
        function switchAuthTab(tab) { document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login'); document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register'); document.getElementById('tab-login').classList.toggle('active', tab === 'login'); document.getElementById('tab-register').classList.toggle('active', tab === 'register'); }

        // === 4. åˆ¤å®šé‚è¼¯ (ç¶­æŒä¸è®Š) ===
        function checkExcellence(kid, joinDateStr) {
            if (!kid.logs || kid.logs.length === 0) return null;
            if (!kid.initialHeight || !joinDateStr) return null;

            const startH = parseFloat(kid.initialHeight); 
            const sortedLogs = [...kid.logs].sort((a, b) => new Date(a.date) - new Date(b.date));
            const lastLog = sortedLogs[sortedLogs.length - 1];
            const endH = parseFloat(lastLog.height);       

            if (isNaN(startH) || isNaN(endH)) return null;

            const growth = endH - startH;
            if (growth <= 0) return null;

            const startDate = new Date(joinDateStr); 
            const endDate = new Date(lastLog.date);  
            const diffTime = endDate - startDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 

            const validDays = diffDays < 1 ? 1 : diffDays;
            const months = validDays / 30.44; 

            let isExcellent = false;
            let reason = "";

            if (validDays <= 92 && growth >= 1.98) {
                isExcellent = true;
                reason = `çŸ­æœŸè¡åˆº (${validDays}å¤© +${growth.toFixed(2)}cm)`;
            } 
            else {
                const rate = growth / months;
                if (rate >= 0.66) {
                    isExcellent = true;
                    reason = `é€Ÿç‡å„ªç•° (${rate.toFixed(2)} cm/æœˆ)`;
                }
            }

            if (isExcellent) {
                return { reason, val: (growth / months).toFixed(2) };
            }
            return null;
        }

        function checkGrowthStagnation(kid, joinDateStr) { 
            let startDate = new Date();
            if (joinDateStr) startDate = new Date(joinDateStr);
            else if (kid.logs && kid.logs.length > 0) startDate = new Date([...kid.logs].sort((a,b)=>(a.date||'').localeCompare(b.date||''))[0].date);
            else return false;

            const today = new Date();
            const fourMonthsThreshold = new Date(startDate);
            fourMonthsThreshold.setMonth(fourMonthsThreshold.getMonth() + 4);

            if (today < fourMonthsThreshold) return false; 
            if (!kid.logs || kid.logs.length === 0) return false;
            
            const sortedLogs = [...kid.logs].sort((a,b)=>(a.date||'').localeCompare(b.date||''));
            const latestLog = sortedLogs[sortedLogs.length - 1]; 
            const latestHeight = Number(latestLog.height);
            const initialHeight = Number(kid.initialHeight || 0);

            return latestHeight <= initialHeight;
        }

        // === 5. å„€è¡¨æ¿èˆ‡åˆ—è¡¨ (V20: åŠ å…¥ç‹€æ…‹åˆ¤æ–·ï¼Œé˜²æ­¢é‡è¤‡ç›£è½) ===
        function initOwnerDashboard() {
            if(isOwnerInit) return; // é¿å…é‡è¤‡åŸ·è¡Œ
            isOwnerInit = true;

            db.collection('families').onSnapshot(snap => {
                ownerFamiliesCache = [];
                document.getElementById('ownerTotalFamilies').innerText = snap.size;
                
                let riskCount = 0;
                let bdayCount = 0, bdayNames = [];
                let excCount = 0;
                let excHtml = ''; 

                const currentMonth = new Date().getMonth();
                let stagnantHtml = '';
                let riskHtml = ''; 

                snap.forEach(doc => {
                    const d = doc.data();
                    ownerFamiliesCache.push({id: doc.id, ...d});
                    
                    if(d.riskLevel === 'red') {
                        riskCount++;
                        riskHtml += `<div onclick="openFamilyModal('${doc.id}')" class="cursor-pointer hover:bg-red-100 p-1 flex justify-between items-center"><span class="underline decoration-dotted text-red-700">${d.parentName}</span> <span class="text-xs text-gray-500">${d.managerName}</span></div>`;
                    }

                    if(d.kids && Array.isArray(d.kids)) {
                        d.kids.forEach(k => {
                            if (k.dob) {
                                const parts = k.dob.split('-');
                                if (parts.length === 3 && (parseInt(parts[1]) - 1) === currentMonth) { bdayCount++; bdayNames.push(k.name); }
                            }
                            
                            if(checkGrowthStagnation(k, d.joinDate)) {
                                stagnantHtml += `<div onclick="openFamilyModal('${doc.id}')" class="bg-white p-2 rounded shadow-sm border border-red-200 flex justify-between cursor-pointer hover:bg-red-50 transition mb-1">
                                    <span class="font-bold text-red-800 underline decoration-dotted">${k.name} (${d.parentName})</span>
                                    <span class="text-xs text-gray-500">${d.managerName}</span>
                                </div>`;
                            }

                            const excCheck = checkExcellence(k, d.joinDate); 
                            if (excCheck) {
                                excCount++;
                                excHtml += `<div onclick="openFamilyModal('${doc.id}')" class="cursor-pointer hover:bg-green-100 p-1 flex justify-between items-center border-b border-green-100 last:border-0">
                                    <div class="flex items-center gap-1">
                                        <i class="fa-solid fa-medal text-yellow-500"></i>
                                        <span class="underline decoration-dotted text-excellentText font-bold">${k.name}</span>
                                        <span class="text-xs text-gray-400">(${d.parentName})</span>
                                    </div>
                                    <span class="text-[10px] bg-white border border-green-200 rounded px-2 py-0.5 text-green-700 font-bold shadow-sm" title="${excCheck.reason}">
                                        ${excCheck.reason.split(' ')[0]} 
                                    </span>
                                </div>`;
                            }
                        });
                    }
                });
                
                updateOwnerCountryFilter(ownerFamiliesCache);
                updateCountryChart(ownerFamiliesCache);
                renderOwnerTable();
                
                document.getElementById('ownerRiskCount').innerText = riskCount;
                document.getElementById('ownerRiskList').innerHTML = riskHtml || 'ç„¡'; 
                document.getElementById('ownerBirthdayCount').innerText = bdayCount;
                document.getElementById('ownerBirthdayList').innerText = bdayNames.length ? bdayNames.join(', ') : 'ç„¡';

                document.getElementById('ownerExcellentCount').innerText = excCount;
                document.getElementById('ownerExcellentList').innerHTML = excHtml || '<div class="text-gray-400 text-center py-2 text-xs">å°šç„¡é”æ¨™å­©ç«¥</div>';
                
                const stagnantBoard = document.getElementById('ownerHealthBoard');
                if(stagnantHtml) { document.getElementById('ownerStagnantList').innerHTML = stagnantHtml; stagnantBoard.classList.remove('hidden'); }
                else { stagnantBoard.classList.add('hidden'); }
            });

            // V23 ä¿®æ­£: äººå“¡ç®¡ç†åˆ—è¡¨ (ç§»é™¤æ‰€æœ‰ã€Œè¨­ç‚ºç¨‹å¼ç®¡ç†è€…ã€æŒ‰éˆ•)
            db.collection('users').where('role', '!=', 'owner').onSnapshot(snap => {
                 let html = '';
                 allStaffCache = []; directorsCache = [];
                 snap.forEach(doc => {
                     const u = doc.data();
                     allStaffCache.push({id: doc.id, name: u.name, role: u.role});
                     if(u.role === 'director') directorsCache.push({id: doc.id, name: u.name});
                 });
 
                 snap.forEach(doc => {
                     const u = doc.data();
                     const isDirector = u.role === 'director';
                     const isAdmin = u.role === 'admin';
                     
                     let directorOptions = `<option value="">ç„¡ç­ä¸»ä»»</option>`;
                     directorsCache.forEach(dir => {
                         if(dir.id !== doc.id) {
                             const selected = u.directorId === dir.id ? 'selected' : '';
                             directorOptions += `<option value="${dir.id}" ${selected}>${dir.name}</option>`;
                         }
                     });
 
                     const assignBlock = (!isDirector && !isAdmin) ? `
                         <div class="mt-2 text-xs flex items-center gap-2">
                             <span class="text-gray-500">æŒ‡æ´¾ç£å°:</span>
                             <select onchange="assignDirector('${doc.id}', this.value)" class="border rounded p-1 text-xs">
                                 ${directorOptions}
                             </select>
                         </div>` : '';
 
                     const transferBtn = !isDirector ? `<button onclick="openTransferModal('${doc.id}', '${u.name}')" class="px-3 py-1 text-xs rounded border bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold"><i class="fa-solid fa-right-left"></i> ç§»äº¤</button>` : '';

                     let roleBadge = isDirector ? 'ç­ä¸»ä»»' : 'ç®¡ç†å¸«';
                     let roleClass = 'text-gray-500';
                     
                     if (isAdmin) {
                         roleBadge = 'ç¨‹å¼ç®¡ç†è€…';
                         roleClass = 'text-adminPurple font-bold';
                     }

                     // V23: ç§»é™¤æ‰€æœ‰ toggleAdmin æŒ‰éˆ•
                     
                     const directorBtn = isAdmin ? '' : `<button onclick="toggleRole('${doc.id}', '${u.role}')" class="px-3 py-1 text-xs rounded border ${isDirector ? 'bg-purple-50 text-purple-600' : 'bg-orange-50 text-orange-600'} font-bold">
                                     ${isDirector ? 'é™ç‚ºç®¡ç†å¸«' : 'å‡ç‚ºç­ä¸»ä»»'}
                                 </button>`;

                     html += `
                     <div class="bg-white border p-3 rounded flex flex-col shadow-sm gap-2">
                         <div class="flex justify-between items-center">
                             <div>
                                 <div class="font-bold text-gray-800">${u.name} <span class="text-xs text-gray-400">(${u.username})</span></div>
                                 <div class="text-xs ${roleClass}"><i class="fa-solid fa-id-badge"></i> ${roleBadge}</div>
                             </div>
                             <div class="flex gap-2 flex-wrap justify-end">
                                 ${transferBtn}
                                 ${directorBtn}
                                 <button onclick="deleteUser('${doc.id}', '${u.name}')" class="px-3 py-1 text-xs rounded border bg-red-50 text-red-600 hover:bg-red-100 font-bold"><i class="fa-solid fa-trash"></i> åˆªé™¤</button>
                             </div>
                         </div>
                         ${assignBlock}
                     </div>`;
                 });
                 document.getElementById('staffList').innerHTML = html || '<p class="text-gray-400 text-sm">æš«ç„¡å…¶ä»–å“¡å·¥</p>';
            });
        }

        // æ›´æ–°åœ‹ç±é¸å–®
        function updateOwnerCountryFilter(families) {
            const select = document.getElementById('ownerCountryFilter');
            const currentVal = select.value;
            const countries = new Set();
            families.forEach(f => { if(f.nationality) countries.add(f.nationality); });
            let html = '<option value="ALL">ğŸŒ æ‰€æœ‰åœ‹ç±</option>';
            countries.forEach(c => { html += `<option value="${c}">${c}</option>`; });
            select.innerHTML = html;
            select.value = currentVal;
        }

        // æ›´æ–°åœ‹ç±æˆæ•ˆåœ–è¡¨
        function updateCountryChart(families) {
            const ctx = document.getElementById('countryGrowthChart').getContext('2d');
            const stats = {};
            families.forEach(f => {
                const nation = f.nationality || 'æœªåˆ†é¡';
                if (!stats[nation]) stats[nation] = { totalKids: 0, excellent: 0, stagnant: 0 };
                if (f.kids && Array.isArray(f.kids)) {
                    f.kids.forEach(k => {
                        stats[nation].totalKids++;
                        if (checkExcellence(k, f.joinDate)) stats[nation].excellent++;
                        if (checkGrowthStagnation(k, f.joinDate)) stats[nation].stagnant++;
                    });
                }
            });

            const labels = Object.keys(stats);
            const dataTotal = labels.map(l => stats[l].totalKids);
            const dataExc = labels.map(l => stats[l].excellent);
            const dataStag = labels.map(l => stats[l].stagnant);

            if (countryChartInstance) countryChartInstance.destroy();

            countryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'å­©ç«¥ç¸½æ•¸', data: dataTotal, backgroundColor: '#BECCE4' },
                        { label: 'å“è¶Šæˆé•· (å„ª)', data: dataExc, backgroundColor: '#10B981' },
                        { label: 'ç”Ÿé•·åœæ»¯ (éšª)', data: dataStag, backgroundColor: '#EF4444' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderOwnerTable() {
            const search = document.getElementById('ownerSearch').value.toLowerCase();
            const countryFilter = document.getElementById('ownerCountryFilter').value;
            const list = ownerFamiliesCache.filter(d => {
                const matchSearch = (d.parentName && d.parentName.toLowerCase().includes(search)) || 
                                    (d.managerName && d.managerName.toLowerCase().includes(search));
                const matchCountry = countryFilter === 'ALL' || d.nationality === countryFilter;
                return matchSearch && matchCountry;
            });
            
            let html = '';
            list.forEach(d => {
                let kidInfo = '-';
                if(d.kids && d.kids.length > 0) {
                    kidInfo = d.kids.map(k => 
                        `<div class="mb-1 h-6 flex items-center">
                            <span class="font-bold text-gray-800 mr-2 text-sm">${k.name}</span>
                            <span class="text-sm text-gray-400">${k.dob || ''}</span>
                         </div>`
                    ).join('<div class="border-t border-gray-100 my-1"></div>');
                }

                let growthInfo = '-';
                if(d.kids && d.kids.length > 0) {
                    growthInfo = d.kids.map(k => {
                        const startH = parseFloat(k.initialHeight); 
                        let currentH = 0;
                        let hasLog = false;
                        if (k.logs && k.logs.length > 0) {
                            const sortedLogs = [...k.logs].sort((a, b) => new Date(a.date) - new Date(b.date));
                            const lastLog = sortedLogs[sortedLogs.length - 1];
                            currentH = parseFloat(lastLog.height);
                            hasLog = true;
                        }

                        if (!isNaN(startH) && hasLog && !isNaN(currentH)) {
                            const diff = currentH - startH;
                            const sign = diff > 0 ? '+' : '';
                            const colorClass = diff > 0 ? 'text-green-600' : (diff < 0 ? 'text-red-500' : 'text-gray-500');
                            return `<div class="mb-1 h-6 flex items-center font-mono">
                                        <span class="${colorClass} font-bold text-sm mr-1">${sign}${diff.toFixed(1)}cm</span>
                                        <span class="text-sm text-gray-400">(${currentH})</span>
                                    </div>`;
                        } else if (hasLog) {
                            return `<div class="mb-1 h-6 flex items-center text-sm text-gray-500">${currentH}cm <span class="text-sm ml-1">(ç¼ºåˆå§‹)</span></div>`;
                        } else {
                            return `<div class="mb-1 h-6 flex items-center text-gray-300">-</div>`;
                        }
                    }).join('<div class="border-t border-gray-100 my-1"></div>');
                }

                html += `<tr class="border-b hover:bg-gray-50 cursor-pointer transition" onclick="openFamilyModal('${d.id}', 'records')">
                    <td class="p-3 align-middle text-sm">${d.nationality}</td>
                    <td class="p-3 align-middle font-bold text-sm text-gray-800">${d.parentName}</td>
                    <td class="p-3 align-middle text-sm">${kidInfo}</td>
                    <td class="p-3 align-middle text-sm">${growthInfo}</td>
                    <td class="p-3 align-middle text-sm text-gray-500">${d.managerName}</td>
                    <td class="p-3 align-middle text-center"><span class="risk-dot ${d.riskLevel==='red'?'bg-red-500':(d.riskLevel==='yellow'?'bg-yellow-500':'bg-green-500')}"></span></td>
                    <td class="p-3 align-middle text-center whitespace-nowrap">
                        <button onclick="event.stopPropagation(); openSingleTransferModal('${d.id}', '${d.parentName}', '${d.managerId}')" class="bg-purple-50 text-purple-600 hover:bg-purple-100 px-2 py-1 rounded text-xs mr-2 font-bold" title="ç§»äº¤æ­¤å®¶åº­"><i class="fa-solid fa-right-left"></i></button>
                        
                        <button onclick="event.stopPropagation(); openFamilyModal('${d.id}')" class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded text-xs mr-2 font-bold"><i class="fa-solid fa-eye"></i></button>
                        
                        <button onclick="event.stopPropagation(); deleteFamily('${d.id}', '${d.parentName}')" class="bg-red-50 text-red-600 hover:bg-red-100 px-2 py-1 rounded text-xs font-bold"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            
            if (list.length === 0) {
                html = '<tr><td colspan="7" class="p-4 text-center text-gray-400">æŸ¥ç„¡è³‡æ–™</td></tr>';
            }

            document.getElementById('ownerFamilyTable').innerHTML = html;
        }

        // === 6. æ¬Šé™ç®¡ç†èˆ‡é€£å‹• (ç¶­æŒä¸è®Š) ===
        async function assignDirector(managerId, directorId) {
            try { await db.collection('users').doc(managerId).update({ directorId: directorId }); } 
            catch(e) { alert("æŒ‡æ´¾å¤±æ•—: " + e.message); }
        }

        async function toggleRole(uid, currentRole) {
            const newRole = currentRole === 'director' ? 'manager' : 'director';
            if(confirm(`ç¢ºå®šè®Šæ›´ç‚º ${newRole === 'director' ? 'ç­ä¸»ä»»' : 'ç®¡ç†å¸«'} å—?`)) {
                await db.collection('users').doc(uid).update({ role: newRole });
            }
        }

        async function deleteUser(uid, name) {
            if(confirm(`è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ\næ­¤æ“ä½œæœƒç§»é™¤è©²å“¡å·¥ç™»å…¥æ¬Šé™ã€‚`)) {
                await db.collection('users').doc(uid).delete();
                alert('å·²åˆªé™¤è©²å“¡å·¥ã€‚');
            }
        }

        let transferSourceId = null;
        function openTransferModal(managerId, managerName) { 
            transferSourceId = managerId;
            document.getElementById('transferModalTitle').innerText = `ç§»äº¤ ${managerName} çš„æ‰€æœ‰å®¶åº­`;
            const select = document.getElementById('targetManagerSelect');
            select.innerHTML = '<option value="">è«‹é¸æ“‡æ¥æ”¶è€…</option>';
            allStaffStaffCache.forEach(s => {
                if(s.id !== managerId) { 
                    select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                }
            });
            document.getElementById('transferModal').classList.remove('hidden');
        }

        async function confirmTransfer() {
            const targetId = document.getElementById('targetManagerSelect').value;
            const targetName = document.getElementById('targetManagerSelect').options[document.getElementById('targetManagerSelect').selectedIndex].text;
            if(!targetId) { alert("è«‹é¸æ“‡æ¥æ”¶è€…"); return; }
            
            showLoading(true);
            try {
                const snapshot = await db.collection('families').where('managerId', '==', transferSourceId).get();
                if(snapshot.empty) { alert("è©²ç®¡ç†å¸«åä¸‹æ²’æœ‰å®¶åº­å¯ç§»äº¤"); showLoading(false); return; }
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.update(doc.ref, { managerId: targetId, managerName: targetName });
                });
                await batch.commit();
                alert(`ç§»äº¤æˆåŠŸï¼å·²å°‡ ${snapshot.size} å€‹å®¶åº­è½‰çµ¦ ${targetName}`);
                document.getElementById('transferModal').classList.add('hidden');
            } catch(e) {
                alert("ç§»äº¤å¤±æ•—: " + e.message);
            }
            showLoading(false);
        }

        // ç­ä¸»ä»»å„€è¡¨æ¿ (åŠ å…¥é˜²é‡è¤‡åŸ·è¡Œ)
        async function initDirectorDashboard() {
            if(isDirectorInit) return;
            isDirectorInit = true;

            db.collection('families').where('managerId', '==', currentUser.uid).onSnapshot(snap => {
                directorPersonalCache = [];
                snap.forEach(doc => directorPersonalCache.push({id: doc.id, ...doc.data()}));
                renderDirectorMyFamilyList();
            });

            const teamDiv = document.getElementById('directorTeamList'); 
            const riskDiv = document.getElementById('directorRiskList');
            const familyTableBody = document.getElementById('directorFamilyTable');
            
            const teamSnap = await db.collection('users').where('directorId', '==', currentUser.uid).get();
            const teamIds = teamSnap.docs.map(doc => doc.id);
            
            if (teamIds.length === 0) {
                teamDiv.innerHTML = '<p class="text-gray-400">ç›®å‰ç„¡åˆ†é…ç®¡ç†å¸«</p>';
                riskDiv.innerHTML = '<p class="text-gray-400">ç„¡è³‡æ–™</p>';
                familyTableBody.innerHTML = '';
                return;
            }

            db.collection('families').where('managerId', 'in', teamIds).onSnapshot(snap => {
                let managerStats = {};
                let riskHtml = '';
                let stagnantHtml = '';
                let tableHtml = '';
                
                snap.forEach(doc => {
                    const d = doc.data();
                    if (!managerStats[d.managerId]) managerStats[d.managerId] = { name: d.managerName, total: 0, stable: 0 };
                    managerStats[d.managerId].total++;
                    if (d.riskLevel === 'green') managerStats[d.managerId].stable++;
                    
                    if (d.riskLevel === 'red' || d.riskLevel === 'yellow') {
                        riskHtml += `<div onclick="openFamilyModal('${doc.id}')" class="cursor-pointer hover:opacity-80 transition bg-white p-2 border-l-4 ${d.riskLevel==='red'?'border-red-500':'border-yellow-500'} mb-2 shadow-sm rounded">
                            <div class="font-bold text-gray-800 underline decoration-dotted">${d.parentName} <i class="fa-solid fa-arrow-up-right-from-square text-xs text-gray-400 ml-1"></i></div>
                            <div class="text-xs text-gray-500">è² è²¬: ${d.managerName}</div>
                        </div>`;
                    }

                    if(d.kids) d.kids.forEach(k => {
                        if(checkGrowthStagnation(k, d.joinDate)) {
                            stagnantHtml += `<div onclick="openFamilyModal('${doc.id}')" class="bg-white p-2 rounded shadow-sm border border-red-200 flex justify-between cursor-pointer hover:bg-red-50 transition mb-1">
                                <span class="font-bold text-red-800 underline decoration-dotted">${k.name}</span>
                                <span class="text-xs text-gray-500">${d.managerName}</span>
                            </div>`;
                        }
                    });

                    let kidInfo = d.kids && d.kids.length > 0 ? d.kids.map(k=>k.name).join(',') : '-';
                    tableHtml += `<tr class="border-b"><td class="p-2">${d.nationality}</td><td class="p-2">${kidInfo}</td><td class="p-2">-</td><td class="p-2">${d.managerName}</td><td class="p-2 text-center"><span class="risk-dot ${d.riskLevel==='red'?'bg-red-500':(d.riskLevel==='yellow'?'bg-yellow-500':'bg-green-500')}"></span></td><td class="p-2 text-center"><button onclick="openFamilyModal('${doc.id}')" class="text-blue-500">æŸ¥çœ‹</button></td></tr>`;
                });

                let statsHtml = '';
                Object.values(managerStats).forEach(s => {
                    const rate = Math.round((s.stable / s.total) * 100);
                    statsHtml += `<div class="flex justify-between items-center border-b py-2"><span>${s.name}</span> <span class="font-bold">${s.total}æˆ¶ (ç©©å®š${rate}%)</span></div>`;
                });
                
                teamDiv.innerHTML = statsHtml;
                riskDiv.innerHTML = riskHtml;
                familyTableBody.innerHTML = tableHtml;

                const dirHealthBoard = document.getElementById('directorHealthBoard');
                if(stagnantHtml) {
                    document.getElementById('directorStagnantList').innerHTML = stagnantHtml;
                    dirHealthBoard.classList.remove('hidden');
                } else {
                    dirHealthBoard.classList.add('hidden');
                }
            });
        }

        // ç­ä¸»ä»»å€‹äººåˆ—è¡¨æ¸²æŸ“ (ç¶­æŒä¸è®Š)
        function renderDirectorMyFamilyList() {
            const container = document.getElementById('directorMyFamilyList');
            const search = document.getElementById('directorMySearch').value.toLowerCase();
            const list = directorPersonalCache.filter(d => 
                (d.parentName && d.parentName.toLowerCase().includes(search))
            );

            if (list.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center bg-white p-6 rounded border text-gray-500">ç„¡ç¬¦åˆè³‡æ–™</div>';
                return;
            }

            let html = '';
            list.forEach(d => {
                const kidNames = d.kids ? d.kids.map(k => k.name).join(', ') : '';
                const riskClass = d.riskLevel === 'red' ? 'border-red-500' : (d.riskLevel === 'yellow' ? 'border-yellow-500' : 'border-green-500');
                
                html += `<div class="bg-white p-4 rounded shadow border-l-4 ${riskClass} hover:shadow-lg transition flex flex-col md:flex-row items-center justify-between gap-4 w-full">
                    <div class="flex-grow w-full md:w-auto cursor-pointer" onclick="openFamilyModal('${d.id}', 'records')">
                        <div class="font-bold text-lg text-gray-800">${d.parentName}</div>
                        <div class="text-sm text-gray-600">${kidNames}</div>
                    </div>
                    <button onclick="openFamilyModal('${d.id}', 'basic')" class="bg-white border border-secondary text-black px-4 py-2 rounded">ç·¨è¼¯</button>
                </div>`;
            });
            container.innerHTML = html;
        }

        // ç®¡ç†å¸«å„€è¡¨æ¿ (åŠ å…¥é˜²é‡è¤‡åŸ·è¡Œ)
        function initManagerDashboard() {
            if(isManagerInit) return;
            isManagerInit = true;

            const list = document.getElementById('managerFamilyList');
            const exSection = document.getElementById('managerExcellentSection');
            const exList = document.getElementById('managerExcellentList');
            
            db.collection('families').where('managerId', '==', currentUser.uid).onSnapshot(snap => {
                if(!list) return;
                let html = '', exHtml = '', hasExcellent = false;
                let bdayCount = 0, bdayNames = [];
                const currentMonth = new Date().getMonth();

                snap.forEach(doc => {
                    const d = doc.data();
                    let isFamilyExc = false;
                    let kidNames = [];
                    
                    if(d.kids) d.kids.forEach(k => {
                        kidNames.push(k.name);
                        if (k.dob) {
                            const parts = k.dob.split('-');
                            if (parts.length === 3 && (parseInt(parts[1]) - 1) === currentMonth) { bdayCount++; bdayNames.push(k.name); }
                        }
                        const check = checkExcellence(k, d.joinDate);
                        if(check) {
                            isFamilyExc = true; hasExcellent = true;
                            exHtml += `<div class="bg-white p-3 rounded border border-green-300 shadow-sm cursor-pointer hover:shadow-md" onclick="openFamilyModal('${doc.id}', 'records')"><div class="font-bold text-green-800 text-lg flex justify-between">${k.name} <i class="fa-solid fa-star text-yellow-500"></i></div><div class="text-xs text-gray-500">${d.parentName}</div><div class="mt-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded inline-block font-bold">${check.reason}</div></div>`;
                        }
                    });

                    html += `<div class="bg-white p-4 rounded shadow border-l-4 ${d.riskLevel==='red'?'border-red-500':(d.riskLevel==='yellow'?'border-yellow-500':'border-green-500')} mb-2 flex flex-col md:flex-row justify-between items-center gap-2">
                        <div class="flex-grow cursor-pointer" onclick="openFamilyModal('${doc.id}', 'records')">
                            <div class="font-bold text-lg text-gray-800">${d.parentName} ${isFamilyExc?'<i class="fa-solid fa-star text-yellow-500 ml-1"></i>':''}</div>
                            <div class="text-xs text-gray-500">åœ‹ç±: ${d.nationality} | å­©ç«¥: ${kidNames.join(', ')}</div>
                        </div>
                        <button onclick="openFamilyModal('${doc.id}', 'basic')" class="bg-gray-100 px-4 py-2 rounded text-sm font-bold hover:bg-gray-200">ç·¨è¼¯</button>
                    </div>`;
                });
                
                list.innerHTML = html;
                document.getElementById('managerTotalCount').innerText = snap.size;
                document.getElementById('managerBirthdayCount').innerText = bdayCount;
                document.getElementById('managerBirthdayList').innerText = bdayNames.length ? bdayNames.join(', ') : 'ç„¡';

                if(exList && hasExcellent) { exList.innerHTML = exHtml; exSection.classList.remove('hidden'); } 
                else { exSection.classList.add('hidden'); }
            });
        }

        // === Modal èˆ‡ è³‡æ–™æ“ä½œ (V26: éª¨é½¡æ¬„ä½å›æ­¸) ===
        function openFamilyModal(id = null, initialTab = 'basic') {
            document.getElementById('familyForm').reset();
            document.getElementById('familyId').value = id || '';
            document.getElementById('modalTitle').innerText = id ? 'ç·¨è¼¯è³‡æ–™' : 'æ–°å¢è³‡æ–™';
            document.getElementById('kidsContainer').innerHTML = '';
            document.getElementById('logsHistoryTable').innerHTML = '';
            
            isModalReadOnly = false;
            switchModalTab(initialTab);
            
            if (id) {
                db.collection('families').doc(id).get().then(doc => {
                    const d = doc.data();
                    currentEditingFamily = { id: doc.id, ...d };
                    
                    if (userData.role === 'director' && d.managerId !== currentUser.uid) {
                        isModalReadOnly = true;
                        document.getElementById('modalTitle').innerText = 'å®¶åº­è³‡æ–™ (åƒ…ä¾›æª¢è¦–)';
                    }

                    document.getElementById('parentName').value = d.parentName;
                    document.getElementById('nationality').value = d.nationality;
                    document.getElementById('joinDate').value = d.joinDate || '';
                    document.getElementById('deadlineDate').value = d.deadlineDate || ''; 
                    document.getElementById('isRenewal').checked = d.isRenewal || false;
                    document.getElementById('logDate').value = new Date().toISOString().split('T')[0];
                    if(d.riskLevel) document.querySelector(`input[name="risk"][value="${d.riskLevel}"]`).checked = true;
                    if(d.kids) d.kids.forEach(k => addKidField(k)); else addKidField();
                    
                    applyReadOnlyState(isModalReadOnly); 
                });
            } else {
                currentEditingFamily = { kids: [] };
                addKidField();
                document.getElementById('logDate').value = new Date().toISOString().split('T')[0];
                applyReadOnlyState(false);
            }
            document.getElementById('familyModal').classList.remove('hidden');
        }

        function applyReadOnlyState(isReadOnly) {
            const inputs = document.querySelectorAll('#familyModal input, #familyModal select, #familyModal textarea');
            inputs.forEach(el => el.disabled = isReadOnly);
            const footer = document.getElementById('modalFooterBtn');
            if(footer) footer.style.display = isReadOnly ? 'none' : 'flex';
            const logBtn = document.getElementById('btnSaveLog');
            if(logBtn) logBtn.style.display = isReadOnly ? 'none' : 'block';
            const addKidBtn = document.getElementById('btnAddKid');
            if(addKidBtn) addKidBtn.style.display = isReadOnly ? 'none' : 'block';
        }

        function closeFamilyModal() { document.getElementById('familyModal').classList.add('hidden'); }
        function switchModalTab(tabName) { 
            document.getElementById('content-basic').classList.toggle('hidden', tabName !== 'basic'); 
            document.getElementById('content-records').classList.toggle('hidden', tabName !== 'records');
            const tBasic = document.getElementById('tab-basic'), tRec = document.getElementById('tab-records');
            const footerBtn = document.getElementById('modalFooterBtn');
            if(tabName === 'basic') {
                tBasic.classList.add('text-primary', 'border-b-2', 'border-primary'); tBasic.classList.remove('text-gray-500');
                tRec.classList.remove('text-primary', 'border-b-2', 'border-primary'); tRec.classList.add('text-gray-500');
                if(!isModalReadOnly) footerBtn.style.display = 'flex';
            } else {
                tRec.classList.add('text-primary', 'border-b-2', 'border-primary'); tRec.classList.remove('text-gray-500');
                tBasic.classList.remove('text-primary', 'border-b-2', 'border-primary'); tBasic.classList.add('text-gray-500');
                footerBtn.style.display = 'none';
                renderKidSelectOptions();
            }
        }

        function addKidField(data = null) {
            const container = document.getElementById('kidsContainer');
            const delBtn = isModalReadOnly ? '' : `<div class="md:col-span-1 text-right"><button type="button" onclick="toggleKidDeletion(this)" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div>`;
            
            // V26 ä¿®æ”¹ï¼šGrid æ”¹ç‚º 6 æ¬„ï¼Œæ–°å¢éª¨é½¡æ¬„ä½
            const html = `<div class="bg-white p-2 rounded border border-gray-200 mb-2 kid-entry">
                <div class="grid grid-cols-2 md:grid-cols-6 gap-2 items-end">
                    <div class="md:col-span-1"><label class="text-[10px] text-gray-400">å§“å</label><input type="text" class="kid-name w-full border p-1 text-sm rounded" value="${data ? data.name : ''}" required ${isModalReadOnly?'disabled':''}></div>
                    <div class="md:col-span-1"><label class="text-[10px] text-gray-400">ç”Ÿæ—¥</label><input type="date" class="kid-dob w-full border p-1 text-sm rounded" value="${data ? data.dob : ''}" ${isModalReadOnly?'disabled':''} max="9999-12-31"></div>
                    <div class="md:col-span-1"><label class="text-[10px] text-gray-400">åˆå§‹èº«é«˜</label><input type="number" step="0.1" class="kid-h w-full border p-1 text-sm rounded" value="${data ? data.initialHeight : ''}" placeholder="cm" ${isModalReadOnly?'disabled':''}></div>
                    <div class="md:col-span-1"><label class="text-[10px] text-gray-400">åˆå§‹é«”é‡</label><input type="number" step="0.1" class="kid-w w-full border p-1 text-sm rounded" value="${data ? data.initialWeight : ''}" placeholder="kg" ${isModalReadOnly?'disabled':''}></div>
                    <div class="md:col-span-1"><label class="text-[10px] text-gray-400">éª¨é½¡ (æ­²)</label><input type="number" step="0.1" class="kid-bone w-full border p-1 text-sm rounded" value="${data ? data.boneAge : ''}" placeholder="æ­²" ${isModalReadOnly?'disabled':''}></div>
                    ${delBtn}
                </div>
                <div class="mt-2">
                    <label class="text-[10px] text-gray-400">åˆå§‹ç‹€æ³èªªæ˜ (å®¶é•·æå‡º)</label>
                    <input type="text" class="kid-status w-full border p-1 text-sm rounded" value="${data ? data.initialStatus || '' : ''}" placeholder="ä¾‹å¦‚ï¼šé£Ÿæ…¾ä¸ä½³ã€ç¡çœ å“è³ªå·®ã€éæ•..." ${isModalReadOnly?'disabled':''}>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        function toggleKidDeletion(btn) {
            const row = btn.closest('.kid-entry');
            if (row.classList.contains('marked-for-deletion')) {
                row.classList.remove('marked-for-deletion');
                btn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                btn.classList.replace('text-green-600', 'text-red-500');
            } else {
                row.classList.add('marked-for-deletion');
                btn.innerHTML = '<i class="fa-solid fa-rotate-left"></i>';
                btn.classList.replace('text-red-500', 'text-green-600');
            }
        }

        function renderKidSelectOptions() {
            const select = document.getElementById('recordKidSelect'); select.innerHTML = '';
            document.querySelectorAll('.kid-entry:not(.marked-for-deletion)').forEach((div, idx) => {
                const name = div.querySelector('.kid-name').value || `å­©ç«¥ ${idx+1}`;
                const opt = document.createElement('option'); opt.value = idx; opt.text = name; select.appendChild(opt);
            });
            renderKidLogs();
        }

        function renderKidLogs() {
            const kidIdx = document.getElementById('recordKidSelect').value; 
            const table = document.getElementById('logsHistoryTable'); table.innerHTML = '';
            
            if (currentEditingFamily && currentEditingFamily.kids && currentEditingFamily.kids[kidIdx]) {
                const logs = currentEditingFamily.kids[kidIdx].logs || [];
                const initH = Number(currentEditingFamily.kids[kidIdx].initialHeight || 0);
                if (logs.length === 0) { table.innerHTML = '<p class="text-center text-xs text-gray-400 p-2">ç„¡ç´€éŒ„</p>'; return; }
                
                const sorted = [...logs].sort((a,b) => (a.date||'').localeCompare(b.date||''));
                
                // V13 ä¿®æ”¹é»ï¼šæ–°å¢ å¿Œå£ å’Œ ç‹€æ³ æ¬„ä½è¡¨é ­
                let html = '<table class="w-full text-xs text-left"><thead class="bg-gray-50"><tr><th class="p-1">æ—¥æœŸ</th><th class="p-1">èº«é«˜</th><th class="p-1">é«”é‡</th><th class="p-1">èŒ¶åŒ…</th><th class="p-1">åŸ·è¡Œ(æ¨/ç©´/é‹)</th><th class="p-1">å¿Œå£</th><th class="p-1">ç‹€æ³</th><th class="p-1">æ“ä½œ</th></tr></thead><tbody>';
                
                for(let i = sorted.length - 1; i >= 0; i--) {
                    const l = sorted[i];
                    let prevH = initH; if(i > 0) prevH = Number(sorted[i-1].height);
                    const diffH = (Number(l.height) - prevH).toFixed(1);
                    const hColor = diffH > 0 ? 'text-green-600' : 'text-gray-400';
                    const exec = `${l.massage||0}/${l.acupoint||0}/${l.exercise||0}`;
                    const origIdx = logs.indexOf(l);
                    
                    const delBtn = isModalReadOnly ? '-' : `<button onclick="deleteLog(${origIdx})" class="text-red-500"><i class="fa-solid fa-trash"></i></button>`;
                    
                    // V13 ä¿®æ”¹é»ï¼šæ–°å¢ å¿Œå£ å’Œ ç‹€æ³ æ¬„ä½å…§å®¹ (ä¸¦åŠ å…¥ truncate é¿å…éé•·)
                    html += `<tr class="border-b"><td class="p-1">${l.date}</td><td class="p-1 font-bold">${l.height} <span class="${hColor} text-[10px]">(${diffH>0?'+':''}${diffH})</span></td><td class="p-1">${l.weight}</td><td class="p-1">${l.teaBags||'-'}</td><td class="p-1">${exec}</td><td class="p-1">${l.diet||'-'}</td><td class="p-1 max-w-[100px] truncate" title="${l.statusReport||''}">${l.statusReport||'-'}</td><td class="p-1">${delBtn}</td></tr>`;
                }
                html += '</tbody></table>';
                table.innerHTML = html;
            }
        }

        async function saveFamily(e) {
            e.preventDefault();
            const id = document.getElementById('familyId').value;
            const kidsData = [];
            
            document.querySelectorAll('.kid-entry:not(.marked-for-deletion)').forEach((div, idx) => {
                const name = div.querySelector('.kid-name').value;
                const dob = div.querySelector('.kid-dob').value;
                let existingLogs = [];
                if(currentEditingFamily && currentEditingFamily.kids) {
                    const match = currentEditingFamily.kids.find(k => k.name === name);
                    if(match) existingLogs = match.logs || [];
                }
                kidsData.push({
                    name, dob, 
                    initialHeight: div.querySelector('.kid-h').value,
                    initialWeight: div.querySelector('.kid-w').value,
                    boneAge: div.querySelector('.kid-bone').value, // V26: å„²å­˜éª¨é½¡
                    initialStatus: div.querySelector('.kid-status').value, 
                    logs: existingLogs
                });
            });

            const data = {
                parentName: document.getElementById('parentName').value,
                nationality: document.getElementById('nationality').value,
                joinDate: document.getElementById('joinDate').value,
                deadlineDate: document.getElementById('deadlineDate').value, 
                isRenewal: document.getElementById('isRenewal').checked,
                kids: kidsData,
                updatedAt: new Date()
            };
            
            if(!id) {
                data.managerId = currentUser.uid;
                data.managerName = userData.name;
                data.createdAt = new Date();
                data.riskLevel = 'green';
                await db.collection('families').add(data);
            } else {
                await db.collection('families').doc(id).update(data);
            }
            closeFamilyModal();
        }

        async function saveLogDirectly() {
            if (!currentEditingFamily || !currentEditingFamily.id) { alert("è«‹å…ˆå„²å­˜åŸºæœ¬è³‡æ–™"); return; }
            const kidIdx = document.getElementById('recordKidSelect').value;
            const newLog = {
                date: document.getElementById('logDate').value,
                height: document.getElementById('logHeight').value,
                weight: document.getElementById('logWeight').value,
                teaBags: document.getElementById('logTeaBags').value,
                massage: document.getElementById('logMassage').value,
                acupoint: document.getElementById('logAcupoint').value,
                exercise: document.getElementById('logExercise').value,
                statusReport: document.getElementById('logStatus').value,
                diet: document.querySelector('input[name="diet"]:checked') ? document.querySelector('input[name="diet"]:checked').value : ''
            };
            
            if(!newLog.date || !newLog.height) { alert("æ—¥æœŸèˆ‡èº«é«˜å¿…å¡«"); return; }
            if(!currentEditingFamily.kids[kidIdx].logs) currentEditingFamily.kids[kidIdx].logs = [];
            
            const existIdx = currentEditingFamily.kids[kidIdx].logs.findIndex(l => l.date === newLog.date);
            if(existIdx > -1) currentEditingFamily.kids[kidIdx].logs[existIdx] = newLog;
            else currentEditingFamily.kids[kidIdx].logs.push(newLog);

            const risk = document.querySelector('input[name="risk"]:checked').value;
            await db.collection('families').doc(currentEditingFamily.id).update({ kids: currentEditingFamily.kids, riskLevel: risk });
            alert("ç´€éŒ„å„²å­˜æˆåŠŸ");
            document.getElementById('logHeight').value = '';
            renderKidLogs();
        }

        async function deleteLog(idx) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;
            const kidIdx = document.getElementById('recordKidSelect').value;
            const deleted = currentEditingFamily.kids[kidIdx].logs.splice(idx, 1)[0];
            await db.collection('families').doc(currentEditingFamily.id).update({ kids: currentEditingFamily.kids });
            renderKidLogs();
            
            showUndoToast("å·²åˆªé™¤ç´€éŒ„", async () => {
                currentEditingFamily.kids[kidIdx].logs.push(deleted);
                currentEditingFamily.kids[kidIdx].logs.sort((a,b) => (a.date||'').localeCompare(b.date||''));
                await db.collection('families').doc(currentEditingFamily.id).update({ kids: currentEditingFamily.kids });
                renderKidLogs();
                closeToast();
            });
        }
        
        async function deleteFamily(id, name) { 
            if(!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€å—?`)) return;
            const docSnap = await db.collection('families').doc(id).get();
            if(!docSnap.exists) return;
            const backup = docSnap.data();

            await db.collection('families').doc(id).delete();
            showUndoToast(`å·²åˆªé™¤å®¶åº­ ${name}`, async () => {
                await db.collection('families').doc(id).set(backup);
                closeToast();
            });
        }

        function showUndoToast(msg, cb) { 
            const t = document.getElementById('undoToast'); 
            document.getElementById('undoMessage').innerText = msg;
            t.classList.remove('hidden'); setTimeout(()=>t.classList.add('show'),10);
            pendingUndoAction = cb; clearTimeout(undoTimeout); undoTimeout = setTimeout(closeToast, 5000);
        }
        function closeToast() { 
            const t = document.getElementById('undoToast'); t.classList.remove('show'); 
            setTimeout(()=>t.classList.add('hidden'),300); pendingUndoAction=null; 
        }
        function executeUndo() { if(pendingUndoAction) { pendingUndoAction(); closeToast(); } }

        document.getElementById('logHeight').addEventListener('input', function() {
            const kidIdx = document.getElementById('recordKidSelect').value;
            if (currentEditingFamily && currentEditingFamily.kids[kidIdx]) {
                const initH = Number(currentEditingFamily.kids[kidIdx].initialHeight || 0);
                if(this.value && initH) {
                    const diff = (this.value - initH).toFixed(1);
                    const span = document.getElementById('heightTrend');
                    span.innerText = diff > 0 ? `+${diff}` : diff;
                    span.className = diff > 0 ? 'text-[10px] font-bold w-12 text-green-600' : 'text-[10px] font-bold w-12 text-red-500';
                }
            }
        });

        // === æ–°å¢ï¼šæ‰“é–‹å–®ä¸€å®¶åº­ç§»äº¤ Modal ===
        function openSingleTransferModal(familyId, parentName, currentManagerId) {
            document.getElementById('transferFamilyId').value = familyId;
            document.getElementById('singleTransferTargetName').innerText = `æ­£åœ¨ç§»äº¤ï¼š${parentName}`;
            
            const select = document.getElementById('singleTargetManagerSelect');
            select.innerHTML = '<option value="">è«‹é¸æ“‡æ–°è² è²¬äºº</option>';
            
            if (typeof allStaffCache !== 'undefined') {
                allStaffCache.forEach(s => {
                    if(s.id !== currentManagerId) { 
                        select.innerHTML += `<option value="${s.id}">${s.name} (${s.role === 'director' ? 'ç­ä¸»ä»»' : 'ç®¡ç†å¸«'})</option>`;
                    }
                });
            } else {
                 console.error("allStaffCacheå°šæœªè¼‰å…¥");
                 select.innerHTML = '<option value="">è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦</option>';
            }
            
            document.getElementById('singleTransferModal').classList.remove('hidden');
        }

        // === æ–°å¢ï¼šåŸ·è¡Œå–®ä¸€ç§»äº¤ ===
        async function confirmSingleTransfer() {
            const familyId = document.getElementById('transferFamilyId').value;
            const targetSelect = document.getElementById('singleTargetManagerSelect');
            const targetId = targetSelect.value;
            
            if(!targetId) { alert("è«‹é¸æ“‡æ–°è² è²¬äºº"); return; }
            
            const targetOptionText = targetSelect.options[targetSelect.selectedIndex].text;
            const targetName = targetOptionText.split(' (')[0]; 
            
            showLoading(true);
            try {
                await db.collection('families').doc(familyId).update({
                    managerId: targetId,
                    managerName: targetName,
                    updatedAt: new Date()
                });
                
                alert(`ç§»äº¤æˆåŠŸï¼å·²è½‰äº¤çµ¦ ${targetName}`);
                document.getElementById('singleTransferModal').classList.add('hidden');
                
            } catch(e) {
                console.error(e);
                alert("ç§»äº¤å¤±æ•—: " + e.message);
            }
            showLoading(false);
        }
    </script>
</body>
</html>